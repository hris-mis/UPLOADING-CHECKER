<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Conflict Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library for Excel file generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
table {
  table-layout: auto;
  width: 100%;
  border-collapse: collapse;
}

th {
  background: linear-gradient(to right, #f9fafb, #f3f4f6);
  text-transform: uppercase;
  letter-spacing: 0.03em;
  font-size: 0.85rem;

        }
.paste-area {
  border: 2px dashed #d1d5db;
  padding: 1rem; /* ‚¨Ö slightly reduced for alignment */
  background-color: #ffffff;
  border-radius: 0.75rem;
  min-height: 300px; /* ‚¨Ö smaller so both boxes match */
  width: 100%;
  white-space: pre;
  overflow-x: auto;
  overflow-y: auto;
  color: #374151;
  cursor: text;
  font-size: 0.9rem;
  letter-spacing: 0.01em;
  border: 1px solid #d1d5db;
  border-left: 4px solid #4f46e5;
}


.paste-area:focus {
  outline: none;
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
}

/* üßæ Make tables fill full width cleanly */
.table-container {
  overflow-x: auto;
  width: 100%;
  max-width: 100%;
  margin: 0 auto;
  border-radius: 0.75rem;
  background-color: #ffffff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  transition: all 0.2s ease-in-out;
}

.table-container table {
  width: 100%;
  table-layout: auto; /* Allow flexible column widths */
}

th:nth-child(1), td:nth-child(1) { width: 14%; } /* Name */
th:nth-child(2), td:nth-child(2) { width: 10%; } /* Emp No */
th:nth-child(3), td:nth-child(3) { width: 12%; } /* Work/Rest Date */
th:nth-child(4), td:nth-child(4) { width: 11%; } /* Shift/Day */
th:nth-child(5), td:nth-child(5) { width: 11%; } /* Day */
th:nth-child(6), td:nth-child(6) { width: 14%; } /* Position (reduced width) */


th, td {
  padding: 0.85rem 1.25rem;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
  white-space: nowrap;
  font-size: 0.9rem;
}

        
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
.conflict {
  background-color: #fff7ed;
  color: #b45309;
  font-weight: 500;
  border-left: 4px solid #f59e0b;
  white-space: pre-wrap;
  word-break: break-word;
  padding: 0.75rem;
  min-width: 320px;
  max-width: 480px;
  border-radius: 0.5rem;
        }
        .weekend-rest-day {
            color: #dc2626;
            font-weight: 500;
        }
        th:first-child, td:first-child {
    position: sticky;
    left: 0;
    background-color: #fffbea; /* light yellow */
    z-index: 2;
    box-shadow: 2px 0 5px rgba(0,0,0,0.05);
}

html, body {
  overflow-x: hidden;
}

/* ‚ú® Subtle row hover animation for corporate polish */
tbody tr {
  transition: background 0.3s ease, transform 0.2s ease;
}
tbody tr:hover {
  background: #f9fafb;
  transform: scale(1.01);
}

    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

<div id="warning-banner"
  class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 
         bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg shadow-md 
         transition-opacity opacity-0">
</div>


<div class="max-w-[1600px] mx-auto">

    <header class="mb-10 text-center">

    <!-- üîπ Navigation Tabs -->
<div class="flex justify-center space-x-4 mb-8">
  <button id="tab-schedule" 
    class="px-6 py-2 rounded-full font-semibold bg-indigo-600 text-white shadow-md hover:bg-indigo-700 transition">
    üóìÔ∏è Schedule Checker
  </button>
  <button id="tab-monitoring" 
    class="px-6 py-2 rounded-full font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition">
    üìä Monitoring
  </button>
</div>

  <h1 class="text-4xl font-extrabold bg-gradient-to-r from-indigo-700 to-blue-500 text-transparent bg-clip-text">
    Schedule Conflict Checker
  </h1>
  <p class="mt-2 text-gray-600 text-sm tracking-wide">
    Validate, review, and export work & rest day schedules with ease.
  </p>
</header>

<!-- ‚úÖ Monitoring Tab -->
<div id="tab-monitoring-content" class="hidden">

  <!-- Header -->
  <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
    üìà Branch Monitoring Dashboard
  </h2>

  <!-- Month & Year Selector -->
<select id="uploaderSelect" class="border rounded px-2 py-1">
  <option value="Claire">Claire</option>
  <option value="Melvin">Melvin</option>
  <option value="Joy">Joy</option>
</select>
<select id="monthSelect" class="border rounded px-2 py-1 ml-2">
  <option value="October-2025">October 2025</option>
  <option value="November-2025">November 2025</option>
  <option value="December-2025">December 2025</option>
</select>


    <div class="flex gap-3">
      <button onclick="addBranch()" 
        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
        ‚ûï Add Branch
      </button>
      <button onclick="editBranches()" 
        class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
        ‚úèÔ∏è Edit Branches
      </button>
    </div>
  </div>

  <!-- Progress Summary -->
  <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
    <div class="flex flex-wrap justify-between text-center">
      <div class="flex-1">
        <p class="text-sm text-gray-500">Total Branches</p>
        <p id="total-branches" class="text-2xl font-bold text-gray-800">200</p>
      </div>
      <div class="flex-1">
        <p class="text-sm text-gray-500">Checked</p>
        <p id="checked-branches" class="text-2xl font-bold text-indigo-600">160</p>
      </div>
      <div class="flex-1">
        <p class="text-sm text-gray-500">Uploaded</p>
        <p id="uploaded-branches" class="text-2xl font-bold text-green-600">145</p>
      </div>
      <div class="flex-1">
        <p class="text-sm text-gray-500">Progress</p>
        <p id="progress-percent" class="text-2xl font-bold text-blue-600">72.5%</p>
      </div>
    </div>

    <div class="w-full bg-gray-200 rounded-full h-4 mt-4">
      <div id="progress-bar" class="h-4 bg-blue-600 rounded-full" style="width: 72.5%;"></div>
    </div>
  </div>

  <!-- Monitoring Table -->
  <div class="table-container">
    <table class="min-w-full">
      <thead>
        <tr>
          <th>Branch</th>
          <th>Check</th>
          <th>Upload</th>
          <th>Uploaded By</th>
          <th>Remarks</th>
          <th>Progress</th>
        </tr>
      </thead>
<div class="flex gap-3 items-center mb-3">
  <select id="monitoringMonth" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
    <option value="01">January</option>
    <option value="02">February</option>
    <option value="03">March</option>
    <option value="04">April</option>
    <option value="05">May</option>
    <option value="06">June</option>
    <option value="07">July</option>
    <option value="08">August</option>
    <option value="09">September</option>
    <option value="10" selected>October</option>
    <option value="11">November</option>
    <option value="12">December</option>
  </select>

  <select id="monitoringYear" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
    <option>2024</option>
    <option selected>2025</option>
    <option>2026</option>
  </select>
</div>
      <tbody id="monitoring-body">
        <tr>
          <td>AASP CEBU</td>
          <td>‚úÖ</td>
          <td>‚úÖ</td>
          <td>Melvin</td>
          <td class="text-green-600 font-medium">Done</td>
          <td>100%</td>
        </tr>
        <tr>
          <td>AASP CLARK</td>
          <td>‚úÖ</td>
          <td>‚¨ú</td>
          <td>-</td>
          <td class="text-yellow-600 font-medium">Pending Check</td>
          <td>66%</td>
        </tr>
      </tbody>
    </table>
  </div>

<!-- Monitoring branch progress area -->
<div class="mt-4">
  <div class="flex items-center space-x-4 mb-4">
    <select id="monthSelect" class="border rounded-lg px-3 py-2 text-sm">
      <option value="2025-10">October 2025</option>
      <option value="2025-11">November 2025</option>
      <option value="2025-12">December 2025</option>
    </select>

    <select id="uploaderSelect" class="border rounded-lg px-3 py-2 text-sm">
      <option value="">All Uploaders</option>
      <option value="Claire">Claire</option>
      <option value="Melvin">Melvin</option>
      <option value="Joy">Joy</option>
    </select>
  </div>

  <div id="branchContainer"
       class="space-y-2 border p-3 rounded-lg bg-white shadow-inner max-h-[450px] overflow-y-auto">
  </div>

  <p id="progressCount" class="text-gray-500 text-sm mt-2"></p>
</div>


</div> <!-- ‚úÖ End of tab-monitoring-content -->

        <!-- Success Message -->
<div id="success-message"
  class="hidden fixed top-6 right-6 bg-gradient-to-r from-green-600 to-emerald-600 text-white 
         py-3 px-6 rounded-lg shadow-lg font-medium transition-transform transform translate-x-full">
  ‚úÖ Validation successful! HRIS upload file has been generated.
</div>

<!-- ‚úÖ Schedule Checker Tab -->
<div id="tab-schedule-content">

<!-- üü¶ WIDER SIDE-BY-SIDE LAYOUT -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch">

  <!-- Work Schedule Section -->
  <div class="bg-white p-6 rounded-lg shadow-sm">
    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
      <h2 class="text-xl font-semibold text-gray-700">1. Paste Work Schedule Data</h2>
      <div class="flex items-center">
        <input type="text" id="work-branch-name" placeholder="Enter Branch Name"
          class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 mr-2">
        <button id="generate-work-btn" onclick="generateHrisFile('work')"
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap">
          Generate File
        </button>
      </div>
    </div>

    <div id="work-schedule-paste" contenteditable="true" class="paste-area" onpaste="handlePaste(event, 'work')"></div>

    <div class="table-container mt-4">
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
<th class="px-2 py-2 text-xs">Name</th>
<th class="px-2 py-2 text-xs">Emp No.</th>
<th class="px-2 py-2 text-xs">Work Date</th>
<th class="px-2 py-2 text-xs">Shift</th>
<th class="px-2 py-2 text-xs">Day</th>
<th class="px-2 py-2 text-xs">Position</th>

          </tr>
        </thead>
        <tbody id="work-schedule-body">
          <!-- JS will populate this -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Rest Day Schedule Section -->
  <div class="bg-white p-6 rounded-lg shadow-sm">
    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
<h2 class="text-xl font-semibold text-gray-700">2. Paste Rest Day Schedule Data</h2>
<div class="flex items-center gap-2">
  <input type="text" id="rest-branch-name" placeholder="Enter Branch Name"
    class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
  <button id="generate-rest-btn" onclick="generateHrisFile('rest')"
    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap">
    Generate File
  </button>
</div>

<!-- Paste Area -->
<div id="rest-day-paste" 
  contenteditable="true"
  class="paste-area"
  onpaste="handlePaste(event, 'rest')"></div>

<!-- Table -->
<div class="table-container mt-4">
  <table class="min-w-full divide-y divide-gray-200">
    <thead>
      <tr>
        <th class="px-2 py-2 text-xs">Conflict</th>
        <th class="px-2 py-2 text-xs">Name</th>
        <th class="px-2 py-2 text-xs">Emp No.</th>
        <th class="px-2 py-2 text-xs">Rest Date</th>
        <th class="px-2 py-2 text-xs">Day</th>
        <th class="px-2 py-2 text-xs">Position</th>
      </tr>
    </thead>
    <tbody id="rest-day-body">
      <!-- JS will populate this -->
    </tbody>
  </table>
</div>


        <!-- Important Notices -->
        <div class="bg-white p-6 rounded-lg shadow-sm border border-yellow-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Important Notices</h3>
            <ul class="space-y-3 text-gray-600">
                <li><strong class="font-semibold text-yellow-800">1:</strong> Branch Heads, Site Supervisors, and OICs are strictly prohibited from taking rest days on the same date.</li>
                <li><strong class="font-semibold text-yellow-800">2:</strong> Validation is based on Employee Number, Rest Day, and Work Date. Ensure Employee Numbers are entered correctly for accurate conflict detection.</li>
                <li><strong class="font-semibold text-yellow-800">3:</strong> Leaders and Team Members can only take a maximum of 2 weekend Rest Days per month.</li>
            </ul>
        </div>
    </div>

    
</div>
<script>

    const branches = [
    "AASP ABREEZA",
    "AASP NES - ATLAS",
    "AASP ANNEX",
    "AASP CDO",
    "AASP CEBU",
    "AASP CLARK",
    "AASP FESTIVAL",
    "GREE",
    "AASP GLORIETTA",
    "ASP ILOILO",
    "ASP MARIKINA",
    "AASP MAISON",
    "ASP NES - CC",
    "ASP NES",
    "ASP NAGA",
    "ASP PODIUM",
    "AASP KCC ZAMBOANGA",
    "WAREHOUSE",
    "OMOTESANDO",
    "APP GREENBELT",
    "AREA MANAGER - KENO CIPRIANO",
    "AASP LIMA",
    "APP MEGAMALL",
    "AASP VERTIS NORTH",
    "RBT COTABATO",
    "RBT SM CITY ANGONO",
    "AASP COTABATO",
    "RBT SM CITY TARLAC",
    "RBT STA. LUCIA",
    "RBT SM CITY NOVALICHES",
    "RBT TAGUM",
    "RBT TORIL",
    "RBT SM CITY TAYTAY",
    "RBT PAGADIAN",
    "RBT SEA SIDE",
    "RBT LILOAN",
    "THE LOOP KCC MALL COTABATO",
    "RBT THE LOOP SIARGAO",
    "RBT UP SHOPPING CENTER",
    "RBT ROB MANILA",
    "AASP LA UNION",
    "RBT SM STA MESA",
    "RBT SM TANUAN",
    "RBT NEW POINT MALL",
    "RBT GAISANO MALL DIGOS",
    "RBT GAPAN",
    "RBT TL SM MUNTINLUPA",
    "RBT LAOAG",
    "RBT SANGANDAAN",
    "ASP MAGNOLIA",
    "ASP TRINOMA",
    "AASP NEWPOINT MALL",
    "ECOMMERCE BACK END ( CONTENT AND DESIGN)",
    "ECOMMERCE FRONT END (SALES AND OPERATION)",
    "SUPPLY MANAGEMENT TEAM - smd",
    "CHAR DINING-COMMISSARY",
    "CHAR DINING-PODIUM",
    "CHAR DINING-SM NORTH EDSA",
    "RBT-ALABANG TOWN CENTER",
    "RBT-ALTA CITTA",
    "RBT-AYALA MANILA BAY",
    "RBT-CASH AND CARRY",
    "RBT-CIRCUIT MAKATI",
    "RBT-DLSU",
    "RBT-EDSA SHANGRI-LA MALL",
    "RBT-ESTANCIA MALL",
    "RBT-FORA MALL",
    "RBT-GLORIETTA 5",
    "RBT-HEAD OFFICE",
    "RBT-ROB ILOCOS NORTE",
    "RBT-NORTHEAST SQUARE",
    "RBT-XIAOMI ONGPIN",
    "RBT-ONGPIN",
    "RBT-ROB GALLERIA SOUTH",
    "RBT-ROB LA UNION",
    "RBT-ROB ORMOC",
    "RBT-ROBINSONS GALLERIA CEBU - CEBU",
    "RBT-SM TUGUEGARAO",
    "RBT-ROBINSONS TUGUEGARAO (- TUGUE)",
    "RBT-ROBINSONS VALENCIA",
    "RBT-SM CITY ROXAS",
    "RBT-SM DASMARINAS",
    "RBT-SM DOWNTOWN CDO",
    "RBT-SM LEGAZPI",
    "RBT-SM LIPA",
    "RBT-SM LUCENA",
    "RBT- APP MALL OF ASIA",
    "RBT-PMC SM MEGAMALL",
    "RBT-SM SAN JOSE DEL MONTE",
    "RBT-SM SAN LAZARO",
    "RBT-SM TRECE MARTIRES",
    "RBT-SM VALENZUELA",
    "RBT-SMALL MEDIUM BUSINESS",
    "RBT-THE LOOP SM CABANATUAN",
    "RBT-UST",
    "RBT-VISTA MALL STA ROSA",
    "RBT-SM CITY ROSARIO",
    "RBT-ROBINSONS NAGA",
    "RBT-AYALA MALLS SERIN",
    "RBT-ISLAND CITY BOHOL",
    "RBT-ROBINSONS SANTIAGO ISABELA",
    "RBT-SM BICUTAN",
    "RBT-MARINA TOWN DUMAGUETE (FILINVEST)",
    "RBT-SM SORSOGON",
    "RBT-SM CAUAYAN",
    "RBT-TL ROBISONS DUMAGUETE",
    "CHAR-G4",
    "THE LOOP UP TOWN",
    "THE LOOP GENSAN",
    "THE LOOP-AYALA CENTER CEBU",
    "THE LOOP-AYALA MALL CENTRAL BLOC CEBU",
    "THE LOOP BONIFACIO HIGH STREET",
    "THE LOOP CENTRIO (Not yet updated for oct)",
    "THE LOOP MITSUKOSHI MALL",
    "THE LOOP SM CITY STA MESA",
    "THE LOOP SM MARILAO",
    "THE LOOP SMAISON",
    "THE LOOP-30TH MALL",
    "THE LOOP-BORACAY",
    "THE LOOP-COLLEGE OF ST BENILDE",
    "THE LOOP-LUCKY CHINATOWN",
    "THE LOOP-SM CITY CALAMBA",
    "THE LOOP-SM UPTOWN CDO (THE LOOP CDO)",
    "THE LOOP-SOUTHWOODS",
    "THE LOOP-BGC UPTOWN MALL",
    "THE LOOP-VIGAN",
    "THE LOOP ROBINSONS TACLOBAN",
    "THE LOOP LIMKETKAI (Not yet updated)",
    "THE LOOP SM MAKATI",
    "RBT MARIKINA",
    "RBT OLONGAPO",
    "RBT PALAWAN",
    "RBT SM CITY PAMPANGA",
    "RBT EASTWOOD",
    "RBT PODIUM (Not updated for Oct)",
    "RBT ROCKWELL (Not updated for Oct)",
    "RBT SAN MATEO",
    "RBT HARBOR POINT SUBIC",
    "RBT-SM SAN PABLO",
    "RBT-SM SANTO TOMAS",
    "RBT-FESTIVAL MALL",
    "RBT-SM SOUTHMALL",
    "RBT-SM STA. ROSA",
    "RBT-SM TANZA",
    "RBT-SM BAGUIO",
    "RBT-SM BATANGAS",
    "RBT-SM BF PARANAQUE",
    "RBT-SM CENTER PULILAN",
    "RBT-SM CENTER TL SAN PEDRO",
    "RBT VENICE",
    "RBT URDANETA",
    "RBT VERTIS NORTH",
    "RBT DAET",
    "RBT ILIGAN",
    "RBT SM CITY BALIWAG",
    "RBT GREENBELT",
    "RBT SM CITY CALOOCAN",
    "RBT TL SM DAGUPAN",
    "RBT EAST ORTIGAS",
    "RBT ECOLAND",
    "RBT FAIRVIEW",
    "RBT SM CITY BATAAN (Not yet updated for Oct)",
    "RBT ROBINSONS BUTUAN",
    "SM BUTUAN",
    "RBT CLOVERLEAF",
    "VISTA MALL BATAAN",
    "RBT TRINOMA",
    "RBT ROBINSONS ILOILO",
    "SM ILOILO",
    "RBT FESTIVE WALK ILOILO (Not updated for Oct)",
    "RBT ROBINSON PANGASINAN",
    "RBT LIMA",
    "RBT VISTA MALL TAGUIG",
    "RBT TL SM ARANETA CITY CUBAO",
    "RBT SM CENTER LEMERY",
    "RBT - VISTA MALL PAMPANGA",
    "RBT - NEW POINT MALL (ANGELES)",
    "RBT - SM MASINAG",
    "RBT SM CITY J MALL CEBU",
    "SM CITY CLARK",
    "RBT GRAND CENTRAL",
    "RBT ABREEZA (Not yet updated)",
    "RBT ANNEX",
    "RBT AURA",
    "RBT BACOLOD",
    "BACOOR (Not yet updated)",
    "RBT AYALA MALL FELIZ",
    "RBT LANANG",
    "RBT MAGNOLIA (Not updated)",
    "RBT SM TELABASTAGAN",
    "RBT ZAMBOANGA",
    "SM MINDPRO",
    "TL ROBINSONS PALAWAN (Not yet updated)",
    "PMC SM MARILAO",
    "XENTRO MALL CALAPAN",
    "SM CITY SUCAT",
    "TL UP SHOPPING CENTER",
    "JR AM_CANARES",
    "PMC TACLOBAN",
    "RSO TL DAVAO",
    "CASHWRAP",
    "APP BONIFACIO HIGH STREET",
    "ADMINISTRATION-PHYSICAL SECURITY",
    "POWERPLANT MALL - ROCKWELL",
    "ASP NORTHEAST",
    "WALTERMART TANAUAN",
    "JAM macasero",
    "SM PUERTO PRINCESA"
  ];


// Default: show Schedule tab only
document.getElementById('tab-schedule-content').classList.remove('hidden');
document.getElementById('tab-monitoring-content').classList.add('hidden');

    // Data stores
    let workScheduleData = [];
    let restDayData = [];

    const LEADERSHIP_POSITIONS = ['Branch Head', 'Site Supervisor', 'OIC'];

    // --- PASTE AND PARSE LOGIC ---
function handlePaste(e, type) {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text/plain');

    e.target.innerText = '';

    const allRows = text.trim().split('\n').map(row => row.split('\t'));

    // ‚úÖ Check if first row is a merged header like "WORK SCHEDULE" or "REST DAY SCHEDULE"
    const hasMergedHeader = allRows[0].length === 1 && 
        (allRows[0][0].toLowerCase().includes('work schedule') || allRows[0][0].toLowerCase().includes('rest day schedule'));

    // ‚úÖ Skip 1 or 2 rows if necessary (title row + column headers)
    const rows = hasMergedHeader ? allRows.slice(2) : allRows.slice(1); 

if (type === 'work') {
    workScheduleData = rows.map(row => {
        let name = '', empNo = '';

        // üîç Detect column order automatically
        if (/^\d+$/.test(row[0]?.trim())) {
            empNo = row[0];
            name = row[1];
        } else {
            name = row[0];
            empNo = row[1];
        }

        return {
            name: name || '',
            empNo: empNo || '',
            date: row[2] ? normalizeDate(row[2]) : '',
            shift: row[3] || '',
            day: row[4] || '',
            position: row[5] || ''
        };
    }).filter(d => d.empNo && d.date);
    renderWorkTable();

} else if (type === 'rest') {
    restDayData = rows.map(row => {
        let name = '', empNo = '';

        // üîç Detect column order automatically
        if (/^\d+$/.test(row[0]?.trim())) {
            empNo = row[0];
            name = row[1];
        } else {
            name = row[0];
            empNo = row[1];
        }

        return {
            empNo: empNo || '',
            name: name || '',
            date: row[2] ? normalizeDate(row[2]) : '',
            day: row[3] || '',
            position: row[4] || '',
            conflicts: []
        };
    }).filter(d => d.empNo && d.date);
}
    validateSchedules();
    
    function normalizeDate(dateString) {
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}/${day}/${year}`;
        } catch(e) {
            return dateString;
        }
    }

    // --- RENDERING LOGIC ---
    function renderWorkTable() {
        const tbody = document.getElementById('work-schedule-body');
        tbody.innerHTML = workScheduleData.map(d => `
            <tr>
                <td>${d.name}</td>
                <td>${d.empNo}</td>
                <td>${d.date}</td>
                <td>${d.shift}</td>
                <td>${d.day}</td>
                <td>${d.position}</td>
            </tr>
        `).join('');
    }

function renderRestDayTable() {
    const tbody = document.getElementById('rest-day-body');
    tbody.innerHTML = restDayData.map(d => {
        const isWeekend = d.day === 'Saturday' || d.day === 'Sunday';
        const hasConflict = d.conflicts.length > 0;
        const rowHighlight = hasConflict ? 'bg-yellow-50 border-l-4 border-yellow-400' : '';
        const conflictMessages = d.conflicts.map(c => `<div><strong>${c.type}:</strong> ${c.reason}</div>`).join('');

        return `
            <tr class="${rowHighlight}">
                <td class="font-medium text-red-600 max-w-xs overflow-y-auto whitespace-pre-line">
                    ${conflictMessages || ''}
                </td>
                <td>${d.name}</td>
                <td>${d.empNo}</td>
                <td class="${isWeekend ? 'weekend-rest-day' : ''}">${d.date}</td>
                <td class="${isWeekend ? 'weekend-rest-day' : ''}">${d.day}</td>
                <td>${d.position}</td>
            </tr>
        `;
    }).join('');

    // ‚úÖ Move summary counter here (after rendering)
    const total = restDayData.length;
    const conflicts = restDayData.filter(d => d.conflicts && d.conflicts.length > 0).length;
    document.getElementById('summary').innerText =
      `${conflicts} out of ${total} entries have conflicts detected.`;

      if (conflicts === 0 && total > 0) {
  document.getElementById('summary').classList.add('text-green-600');
  document.getElementById('summary').innerText = `‚úÖ No conflicts detected for ${total} entries.`;
} else {
  document.getElementById('summary').classList.remove('text-green-600');
}

}
    
    // --- BUTTON AND STATE MANAGEMENT ---
    function updateButtonStates() {
        const workBtn = document.getElementById('generate-work-btn');
        const restBtn = document.getElementById('generate-rest-btn');

        workBtn.disabled = workScheduleData.length === 0;

        const hasConflicts = restDayData.some(d => d.conflicts.length > 0);
        restBtn.disabled = restDayData.length === 0 || hasConflicts;
    }

    // --- VALIDATION LOGIC ---
function validateSchedules() {
    if (workScheduleData.length > 0 || restDayData.length > 0) {
        restDayData.forEach(rd => rd.conflicts = []);

        const workScheduleMap = new Map(workScheduleData.map(ws => [`${ws.empNo}-${ws.date}`, ws]));
        const empNumbersInWork = new Set(workScheduleData.map(ws => ws.empNo));
        const restDaysByDate = {};
        const weekendRestDaysByEmployee = {};
        const seenRestEntries = new Set();

        restDayData.forEach(rd => {
            if (!restDaysByDate[rd.date]) restDaysByDate[rd.date] = [];
            restDaysByDate[rd.date].push(rd);

            // --- Weekend Count ---
            const isWeekend = rd.day === 'Saturday' || rd.day === 'Sunday';
            if (isWeekend) {
                const monthYear = rd.date.substring(0, 2) + '/' + rd.date.substring(6, 10);
                const key = `${rd.empNo}-${monthYear}`;
                if (!weekendRestDaysByEmployee[key]) weekendRestDaysByEmployee[key] = 0;
                weekendRestDaysByEmployee[key]++;
            }

            // --- Duplicate Entry Check ---
            const uniqueKey = `${rd.empNo}-${rd.date}`;
            if (seenRestEntries.has(uniqueKey)) {
                rd.conflicts.push({ type: 'Duplicate Entry', reason: 'Duplicate rest day entry found for same employee and date.' });
            } else {
                seenRestEntries.add(uniqueKey);
            }

            // --- Invalid Date Format ---
            const d = new Date(rd.date);
            if (isNaN(d.getTime())) {
                rd.conflicts.push({ type: 'Invalid Date Format', reason: 'Date format unrecognized or invalid.' });
            }

            // --- Missing Employee Check ---
            if (!empNumbersInWork.has(rd.empNo)) {
                rd.conflicts.push({ type: 'Missing Employee', reason: 'Employee found in Rest Day sheet but not in Work Schedule data.' });
            }

            // --- Work Conflict ---
            if (workScheduleMap.has(uniqueKey)) {
                rd.conflicts.push({ type: 'Work Conflict', reason: 'Employee has a work schedule on the same date as their rest day.' });
            }
        });

        // --- Leadership Conflict ---
        for (const date in restDaysByDate) {
            const leadersOnRest = restDaysByDate[date].filter(rd => LEADERSHIP_POSITIONS.includes(rd.position));
            if (leadersOnRest.length > 1) {
                leadersOnRest.forEach(rd => {
                    rd.conflicts.push({ type: 'Leadership Conflict', reason: 'Multiple leaders (Branch Head/Supervisor/OIC) have the same rest day.' });
                });
            }
        }
// --- Weekend Pair Validation (optional enhancement) ---
const weekendPairs = [
    ['Thursday', 'Friday'],
    ['Friday', 'Saturday'],
    ['Saturday', 'Sunday'],
    ['Sunday', 'Monday']
];

const groupedByEmp = {};
restDayData.forEach(rd => {
    if (!groupedByEmp[rd.empNo]) groupedByEmp[rd.empNo] = [];
    groupedByEmp[rd.empNo].push(rd);
});

Object.keys(groupedByEmp).forEach(empNo => {
    const empDays = groupedByEmp[empNo];
    const dayNames = empDays.map(d => d.day);
    let detectedPairs = new Set();

    weekendPairs.forEach(([a, b]) => {
        if (dayNames.includes(a) && dayNames.includes(b)) {
            detectedPairs.add(`${a}-${b}`);
        }
    });

    const hasFriday = dayNames.includes('Friday');
    const hasSaturday = dayNames.includes('Saturday');
    const hasWeekday = dayNames.some(d => !['Friday','Saturday','Sunday'].includes(d));
    if (hasFriday && hasWeekday) detectedPairs.add('Friday + Weekday');
    if (hasSaturday && hasWeekday) detectedPairs.add('Saturday + Weekday');

    if (detectedPairs.size > 2) {
        const reason = `Weekend Limit Exceeded: ${detectedPairs.size} weekend RDs (${[...detectedPairs].join(', ')})`;
        empDays.forEach(d => {
            d.conflicts.push({ type: 'Weekend Pair Violation', reason });
        });
    }
});

        // --- Weekend Limit Exceeded ---
        for (const key in weekendRestDaysByEmployee) {
            if (weekendRestDaysByEmployee[key] > 2) {
                const [empNo, monthYear] = key.split('-');
                restDayData.forEach(rd => {
                    const rdMonthYear = rd.date.substring(0, 2) + '/' + rd.date.substring(6, 10);
                    const isWeekend = rd.day === 'Saturday' || rd.day === 'Sunday';
                    if (rd.empNo === empNo && rdMonthYear === monthYear && isWeekend) {
                        rd.conflicts.push({
                            type: 'Weekend Limit Exceeded',
                            reason: `${weekendRestDaysByEmployee[key]} weekend rest days found ‚Äî maximum allowed is 2.`
                        });
                    }
                });
            }
        }
    }

    // ‚úÖ Scroll to first conflict if any
const firstConflict = restDayData.find(rd => rd.conflicts.length > 0);
if (firstConflict) {
  setTimeout(() => {
    const row = document.querySelector('td.font-medium.text-red-600');
    if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 200);
}

    renderRestDayTable();
    updateButtonStates();
}
}
    // --- FILE GENERATION ---
// --- FILE GENERATION ---
function generateHrisFile(type) {
  const banner = document.getElementById('warning-banner');

  function showBanner(message) {
    banner.textContent = message;
    banner.classList.remove('hidden');
    banner.classList.add('opacity-100');
    setTimeout(() => {
      banner.classList.remove('opacity-100');
      setTimeout(() => banner.classList.add('hidden'), 500);
    }, 4000);
  }

  let branchName = '';
  let data = [];
  let filename = '';

  if (type === 'work') {
    branchName = document.getElementById('work-branch-name').value.trim();
    if (!branchName) {
      showBanner("‚ö†Ô∏è Please enter the Work Branch Name before generating the file.");
      return;
    }
    if (workScheduleData.length === 0) {
      showBanner("‚ö†Ô∏è No Work Schedule data found. Please paste it first.");
      return;
    }

    data = workScheduleData.map(item => ({
      'Employee Number': item.empNo,
      'Work Date': item.date,
      'Shift Code': item.shift || ''
    }));

    filename = `${branchName}_WORK_SCHEDULE.xlsx`;
  }

  else if (type === 'rest') {
    branchName = document.getElementById('rest-branch-name').value.trim();
    if (!branchName) {
      showBanner("‚ö†Ô∏è Please enter the Rest Branch Name before generating the file.");
      return;
    }
    if (restDayData.length === 0) {
      showBanner("‚ö†Ô∏è No Rest Day Schedule data found. Please paste it first.");
      return;
    }

    data = restDayData.map(item => ({
      'Employee No': item.empNo,
      'Rest Day Date': item.date
    }));

    const defaultFilename = 'REST_DAY_UPLOAD.xlsx';
    filename = branchName ? `${branchName}_${defaultFilename}` : defaultFilename;
  }

  else {
    showBanner("‚ö†Ô∏è Invalid generation type.");
    return;
  }

  // ‚úÖ Generate Excel file
  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'HRIS Upload');
  XLSX.writeFile(workbook, filename);

  // ‚úÖ Show success message
  showSuccessMessage();
}

// --- SUCCESS MESSAGE ---
function showSuccessMessage() {
  const msg = document.getElementById('success-message');
  msg.classList.remove('hidden', 'translate-x-full');
  msg.classList.add('translate-x-0');
  setTimeout(() => {
    msg.classList.remove('translate-x-0');
    msg.classList.add('translate-x-full');
    setTimeout(() => msg.classList.add('hidden'), 300);
  }, 3000);
}

// --- CLEAR ALL DATA ---
function clearAllData() {
  workScheduleData = [];
  restDayData = [];
  document.getElementById('work-schedule-paste').innerText = '';
  document.getElementById('rest-day-paste').innerText = '';
  document.getElementById('work-branch-name').value = '';
  document.getElementById('rest-branch-name').value = '';
  document.getElementById('summary').innerText = '';
  document.getElementById('summary').classList.remove('text-green-600');
  renderWorkTable();
  renderRestDayTable();
  updateButtonStates();

  // üßπ Optional: show confirmation banner
  const banner = document.getElementById('warning-banner');
  banner.textContent = "üßπ All data cleared successfully.";
  banner.classList.remove('hidden');
  banner.classList.add('opacity-100');
  setTimeout(() => {
    banner.classList.remove('opacity-100');
    setTimeout(() => banner.classList.add('hidden'), 500);
  }, 3000);
}

// TAB SWITCHING LOGIC
document.getElementById('tab-schedule').addEventListener('click', () => {
  // Show Schedule tab content and hide Monitoring content
  document.getElementById('tab-schedule-content').classList.remove('hidden');
  document.getElementById('tab-monitoring-content').classList.add('hidden');

  // Update button styling for active tab
  document.getElementById('tab-schedule').classList.add('bg-indigo-600', 'text-white');
  document.getElementById('tab-monitoring').classList.remove('bg-indigo-600', 'text-white');
  document.getElementById('tab-monitoring').classList.add('bg-gray-200', 'text-gray-700');
});


document.getElementById('tab-monitoring').addEventListener('click', () => {
  // Show Monitoring tab content and hide Schedule content
  document.getElementById('tab-monitoring-content').classList.remove('hidden');
  document.getElementById('tab-schedule-content').classList.add('hidden');

  // Update button styling for active tab
  document.getElementById('tab-monitoring').classList.add('bg-indigo-600', 'text-white');
  document.getElementById('tab-schedule').classList.remove('bg-indigo-600', 'text-white');
  document.getElementById('tab-schedule').classList.add('bg-gray-200', 'text-gray-700');
});


// --- Placeholder functions for future add/edit ---
function addBranch() {
  alert('üü¢ Add Branch feature coming soon!');
}

function editBranches() {
  alert('‚úèÔ∏è Edit Branches feature coming soon!');
}

/* --- MONITORING TAB LOCAL SAVE (Per Month Version) --- */
const monitoringBody = document.getElementById("monitoring-body");
const monthSelect = document.getElementById("monthSelect");

function getStorageKey() {
  return `branchMonitoring_${monthSelect.value}`;
}

// üîπ Load saved data when page opens or month changes
function loadMonitoringData() {
  const saved = JSON.parse(localStorage.getItem(getStorageKey()) || "[]");
  if (saved.length > 0) {
    renderMonitoringTable(saved);
  } else {
    initializeMonitoringTable();
  }
}

// üîπ Save data to localStorage
function saveMonitoringData() {
  const rows = [...document.querySelectorAll("#monitoring-body tr")].map(tr => {
    const tds = tr.querySelectorAll("td");
    return {
      branch: tds[0].innerText,
      checked: tds[1].querySelector("input")?.checked || false,
      uploaded: tds[2].querySelector("input")?.checked || false,
      uploadedBy: tds[3].querySelector("input")?.value || "",
      remarks: tds[4].querySelector("input")?.value || ""
    };
  });
  localStorage.setItem(getStorageKey(), JSON.stringify(rows));
}

// üîπ Render table dynamically
function renderMonitoringTable(data) {
  monitoringBody.innerHTML = data.map(item => `
    <tr class="hover:bg-gray-50">
      <td class="font-medium text-gray-800">${item.branch}</td>
      <td class="text-center"><input type="checkbox" ${item.checked ? "checked" : ""} onchange="saveMonitoringData()"></td>
      <td class="text-center"><input type="checkbox" ${item.uploaded ? "checked" : ""} onchange="saveMonitoringData()"></td>
      <td><input type="text" value="${item.uploadedBy}" class="border rounded px-2 py-1 w-full" oninput="saveMonitoringData()"></td>
      <td><input type="text" value="${item.remarks}" class="border rounded px-2 py-1 w-full" oninput="saveMonitoringData()"></td>
      <td class="text-center text-blue-600 font-semibold">
        ${item.checked && item.uploaded ? "‚úÖ Done" : "‚è≥ Pending"}
      </td>
    </tr>
  `).join("");
}

// üîç SEARCH FUNCTIONALITY
document.getElementById("monitoringSearch").addEventListener("input", (e) => {
  const term = e.target.value.toLowerCase();
  const all = JSON.parse(localStorage.getItem("branchMonitoring") || "[]");
  const filtered = all.filter(b => b.branch.toLowerCase().includes(term));
  renderMonitoringTable(filtered);
});


// üîπ Initialize table for new month
function initializeMonitoringTable() {
  const initialData = branches.map(name => ({
    branch: name,
    checked: false,
    uploaded: false,
    uploadedBy: "",
    remarks: ""
  }));
  renderMonitoringTable(initialData);
  localStorage.setItem(getStorageKey(), JSON.stringify(initialData));
}

// üîπ When month changes ‚Üí reload data
monthSelect.addEventListener("change", loadMonitoringData);

// üîπ Load on page open
window.addEventListener("load", loadMonitoringData);


</script>

<!-- ‚úÖ Warning Banner -->
<div id="warning-banner"
  class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 
         bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg shadow-md 
         transition-opacity opacity-0">
</div>

<script>
  // ===== MONITORING FUNCTIONALITY =====
  const container = document.getElementById("branchContainer");
  const uploader = document.getElementById("uploaderSelect");
  const month = document.getElementById("monthSelect");

  function renderBranches() {
    container.innerHTML = "";
    branches.forEach(branch => {
      const row = document.createElement("div");
      row.className = "flex items-center gap-2";
      row.innerHTML = `
        <input type="checkbox" id="${branch}" class="branchCheck" />
        <label for="${branch}" class="text-sm">${branch}</label>
      `;
      container.appendChild(row);
    });
    loadProgress();
  }

  function saveProgress() {
    const key = `${uploader.value}_${month.value}`;
    const data = {};
    document.querySelectorAll(".branchCheck").forEach(cb => {
      data[cb.id] = cb.checked;
    });
    localStorage.setItem(key, JSON.stringify(data));
    updateProgress();
  }

  function loadProgress() {
    const key = `${uploader.value}_${month.value}`;
    const saved = JSON.parse(localStorage.getItem(key) || "{}");
    document.querySelectorAll(".branchCheck").forEach(cb => {
      cb.checked = !!saved[cb.id];
    });
    updateProgress();
  }

  function updateProgress() {
    const total = document.querySelectorAll(".branchCheck").length;
    const done = document.querySelectorAll(".branchCheck:checked").length;
    document.getElementById("progressCount").textContent = `${done}/${total} completed`;
  }

  document.addEventListener("change", e => {
    if (e.target.classList.contains("branchCheck")) saveProgress();
    if (e.target.id === "uploaderSelect" || e.target.id === "monthSelect") renderBranches();
  });

  renderBranches();
</script>

</body>
</html>