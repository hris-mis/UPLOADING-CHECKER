<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Schedule Conflict Checker ‚Äî Fixed</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
<!-- Library for Excel file generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  table { table-layout: auto; width: 100%; border-collapse: collapse; }
  th { background: linear-gradient(to right, #f9fafb, #f3f4f6); text-transform: uppercase; letter-spacing: 0.03em; font-size: 0.85rem; }
  .paste-area { border: 2px dashed #d1d5db; padding: 1rem; background-color: #ffffff; border-radius: 0.75rem; min-height: 300px; width: 100%; white-space: pre; overflow-x: auto; overflow-y: auto; color: #374151; cursor: text; font-size: 0.9rem; letter-spacing: 0.01em; border: 1px solid #d1d5db; border-left: 4px solid #4f46e5; }
  .paste-area:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
  .conflict { background-color: #fff7ed; color: #b45309; font-weight: 500; border-left: 4px solid #f59e0b; white-space: pre-wrap; word-break: break-word; padding: 0.75rem; border-radius: 0.5rem; }
  .weekend-rest-day { color: #dc2626; font-weight: 500; }
  th:first-child, td:first-child { position: sticky; left: 0; background-color: #fffbea; z-index: 2; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
  tbody tr:hover { background: #f9fafb; transform: scale(1.01); }
</style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

<div id="warning-banner" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg shadow-md transition-opacity opacity-0"></div>
<div class="max-w-[1400px] mx-auto">
  <header class="mb-10 text-center">
    <div class="flex justify-center space-x-4 mb-8">
      <button id="tab-schedule" class="px-6 py-2 rounded-full font-semibold bg-indigo-600 text-white shadow-md hover:bg-indigo-700 transition">üóìÔ∏è Schedule Checker</button>
      <button id="tab-monitoring" class="px-6 py-2 rounded-full font-semibold bg-gray-200 text-gray-700 hover:bg-indigo-100 transition">üìä Monitoring</button>
    </div>
  </header>

  <div id="tab-schedule-content">
    <h1 class="text-3xl font-extrabold text-center mt-4">Schedule Conflict Checker</h1>
    <p class="mt-2 text-center text-gray-600 mb-8">Paste, validate, and generate HRIS upload files for Work and Rest Day schedules.</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 divide-x divide-gray-200 px-8 py-6">
      <!-- Work -->
      <div>
        <div class="flex items-center justify-between mb-4 gap-4">
          <h3 class="font-semibold text-lg">1. Paste Work Schedule Data</h3>
          <div class="flex items-center gap-3">
            <input id="workBranchName" type="text" placeholder="Branch Name" class="border rounded px-3 py-2" />
            <button id="generateWorkFile" class="bg-indigo-600 text-white px-4 py-2 rounded">Generate</button>
            <button id="clearWorkData" class="bg-gray-100 px-4 py-2 rounded">Clear</button>
          </div>
        </div>
        <textarea id="workScheduleInput" class="w-full h-64 border rounded p-3 mb-4" placeholder="Paste work schedule (Excel copy) here"></textarea>
        <div class="overflow-auto bg-white rounded border">
          <table class="w-full text-sm text-center">
            <thead class="bg-gray-50 text-gray-600 text-xs">
              <tr><th>Name</th><th>Emp No.</th><th>Work Date</th><th>Shift</th><th>Day</th><th>Position</th></tr>
            </thead>
            <tbody id="workTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Rest -->
      <div>
        <div class="flex items-center justify-between mb-4 gap-4">
          <h3 class="font-semibold text-lg">2. Paste Rest Day Schedule Data</h3>
          <div class="flex items-center gap-3">
            <input id="restBranchName" type="text" placeholder="Branch Name" class="border rounded px-3 py-2" />
            <button id="generateRestFile" class="bg-indigo-600 text-white px-4 py-2 rounded">Generate</button>
            <button id="clearRestData" class="bg-gray-100 px-4 py-2 rounded">Clear</button>
          </div>
        </div>
        <textarea id="restScheduleInput" class="w-full h-64 border rounded p-3 mb-4" placeholder="Paste rest day schedule (Excel copy) here"></textarea>
        <div class="overflow-auto bg-white rounded border">
          <table class="w-full text-sm text-center">
            <thead class="bg-gray-50 text-gray-600 text-xs">
              <tr><th>Conflict</th><th>Name</th><th>Emp No.</th><th>Rest Date</th><th>Day</th><th>Position</th></tr>
            </thead>
            <tbody id="restTableBody"></tbody>
          </table>
        </div>
        <p id="summary" class="mt-3 text-sm text-center text-gray-700"></p>
      </div>
    </div>
  </div>

  <!-- MONITORING -->
  <div id="tab-monitoring-content" class="hidden">
    <h2 class="text-2xl text-center mb-4">üìä Branch Monitoring Dashboard</h2>
    <div class="flex justify-center gap-3 mb-4">
      <select id="monthSelect" class="border rounded px-3 py-2"><option value="01">January</option><option value="02">February</option><option value="10" selected>October</option></select>
      <select id="yearSelect" class="border rounded px-3 py-2"><option value="2025" selected>2025</option><option value="2026">2026</option></select>
      <button id="clearMonitoringBtn" class="bg-red-500 text-white px-4 py-2 rounded">Clear</button>
      <button id="exportMonitoringBtn" class="bg-green-600 text-white px-4 py-2 rounded">Export</button>
    </div>
    <div class="overflow-auto bg-white rounded border">
      <table class="w-full text-sm text-center">
        <thead class="bg-gray-100"><tr><th>Branch</th><th>Check</th><th>Upload</th><th>Uploaded By</th><th>Remarks</th><th>Progress</th></tr></thead>
        <tbody id="monitoringBody"></tbody>
      </table>
    </div>
    <p class="mt-4 text-center">Total: <span id="totalBranches">0</span> | Checked: <span id="checkedBranches">0</span> | Uploaded: <span id="uploadedBranches">0</span> | <span id="progressPercent">0%</span></p>
    <div class="w-1/2 mx-auto bg-gray-200 rounded-full h-3 mt-2"><div id="progressBar" class="h-3 bg-green-500 rounded-full w-0"></div></div>
  </div>

</div>

<script>
// Wrapped in DOMContentLoaded to ensure elements exist
document.addEventListener('DOMContentLoaded', () => {
  /***** State *****/
  let workScheduleData = [];
  let restDayData = [];
  const LEADERSHIP_POSITIONS = ['Branch Head','Site Supervisor','OIC'];

  /***** Element refs *****/
  const workInput = document.getElementById('workScheduleInput');
  const restInput = document.getElementById('restScheduleInput');
  const workTableBody = document.getElementById('workTableBody');
  const restTableBody = document.getElementById('restTableBody');
  const summaryEl = document.getElementById('summary');
  const warningBanner = document.getElementById('warning-banner');
  const successMsg = document.getElementById('success-message');

  const generateWorkFileBtn = document.getElementById('generateWorkFile');
  const generateRestFileBtn = document.getElementById('generateRestFile');
  const clearWorkBtn = document.getElementById('clearWorkData');
  const clearRestBtn = document.getElementById('clearRestData');

  const tabSchedule = document.getElementById('tab-schedule');
  const tabMonitoring = document.getElementById('tab-monitoring');
  const scheduleContent = document.getElementById('tab-schedule-content');
  const monitoringContent = document.getElementById('tab-monitoring-content');

  // Monitoring refs
  const monitoringBody = document.getElementById('monitoringBody');
  const clearMonitoringBtn = document.getElementById('clearMonitoringBtn');
  const exportMonitoringBtn = document.getElementById('exportMonitoringBtn');
  const monthSelect = document.getElementById('monthSelect');
  const yearSelect = document.getElementById('yearSelect');
  const totalBranchesEl = document.getElementById('totalBranches');
  const checkedBranchesEl = document.getElementById('checkedBranches');
  const uploadedBranchesEl = document.getElementById('uploadedBranches');
  const progressPercentEl = document.getElementById('progressPercent');
  const progressBar = document.getElementById('progressBar');

  /***** Helpers *****/
  function showBanner(msg) {
    warningBanner.textContent = msg;
    warningBanner.classList.remove('hidden');
    warningBanner.classList.add('opacity-100');
    setTimeout(() => { warningBanner.classList.remove('opacity-100'); setTimeout(() => warningBanner.classList.add('hidden'), 400); }, 3000);
  }

  function showSuccess() {
    successMsg.classList.remove('hidden');
    setTimeout(() => { successMsg.classList.add('hidden'); }, 2300);
  }

  function parseTabular(text) {
    if (!text) return [];
    const lines = text.replace(/\r/g,'').split('\n').map(l => l.trim()).filter(Boolean);
    return lines.map(line => line.split(/\t|,|\s{2,}/).map(c => c.trim()));
  }

  function detectHeaderAndMap(rows) {
    if (!rows || rows.length === 0) return { dataRows: [], colMap: {} };
    const first = rows[0].map(c => (c||'').toString().toLowerCase());
    let hasHeader = first.some(cell => /name|emp|employee|date|shift|position|day/.test(cell));
    let colMap = {};
    let dataStart = 0;

    if (hasHeader) {
      dataStart = 1;
      for (let i=0;i<first.length;i++) {
        const h = first[i];
        if (/emp|employee number|employee no|emp no/.test(h)) colMap.empNo = i;
        else if (/name/.test(h)) colMap.name = i;
        else if (/rest.*date|work.*date|date/.test(h)) colMap.date = i;
        else if (/shift/.test(h)) colMap.shift = i;
        else if (/day/.test(h)) colMap.day = i;
        else if (/position|pos/.test(h)) colMap.position = i;
      }
    } else {
      // guess typical order
      const sample = rows[0];
      if (/^\d+$/.test((sample[0]||'').replace(/[^0-9]/g,''))) {
        colMap = { empNo:0, name:1, date:2, shift:3, day:4, position:5 };
      } else {
        colMap = { name:0, empNo:1, date:2, shift:3, day:4, position:5 };
      }
    }

    return { dataRows: rows.slice(dataStart), colMap };
  }

  function normalizeDate(dateString) {
    if (!dateString) return '';
    const d = new Date(dateString);
    if (isNaN(d.getTime())) return dateString;
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${mm}/${dd}/${yyyy}`;
  }

  /***** Rendering *****/
  function renderWorkTable() {
    workTableBody.innerHTML = workScheduleData.map(d => `
      <tr>
        <td>${escapeHtml(d.name)}</td>
        <td>${escapeHtml(d.empNo)}</td>
        <td>${escapeHtml(d.date)}</td>
        <td>${escapeHtml(d.shift)}</td>
        <td>${escapeHtml(d.day)}</td>
        <td>${escapeHtml(d.position)}</td>
      </tr>
    `).join('');
  }

  function renderRestTable() {
    restTableBody.innerHTML = restDayData.map(d => {
      const isWeekend = /saturday|sunday/i.test(d.day || '');
      const conflictHtml = (d.conflicts || []).map(c => `<div><strong>${escapeHtml(c.type)}:</strong> ${escapeHtml(c.reason)}</div>`).join('');
      const rowClass = (d.conflicts && d.conflicts.length)>0 ? 'bg-yellow-50 border-l-4 border-yellow-400' : '';
      return `
        <tr class="${rowClass}">
          <td class="text-left p-2 max-w-xs">${conflictHtml}</td>
          <td>${escapeHtml(d.name)}</td>
          <td>${escapeHtml(d.empNo)}</td>
          <td class="${isWeekend? 'weekend-rest-day':''}">${escapeHtml(d.date)}</td>
          <td class="${isWeekend? 'weekend-rest-day':''}">${escapeHtml(d.day)}</td>
          <td>${escapeHtml(d.position)}</td>
        </tr>
      `;
    }).join('');

    const total = restDayData.length;
    const conflicts = restDayData.filter(r=>r.conflicts && r.conflicts.length>0).length;
    if (total === 0) { summaryEl.textContent = ''; }
    else if (conflicts === 0) { summaryEl.textContent = `‚úÖ No conflicts detected for ${total} entries.`; summaryEl.classList.add('text-green-600'); }
    else { summaryEl.textContent = `${conflicts} out of ${total} entries have conflicts detected.`; summaryEl.classList.remove('text-green-600'); }
  }

  function escapeHtml(str){ return (str==null) ? '' : String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  /***** Validation *****/
  function validateSchedules() {
    // reset conflicts
    restDayData.forEach(r => r.conflicts = []);

    // build maps
    const workMap = new Map(workScheduleData.map(w => [`${w.empNo}-${w.date}`, w]));
    const workEmpSet = new Set(workScheduleData.map(w => w.empNo));
    const restByDate = {};
    const weekendCount = {};
    const seen = new Set();

    restDayData.forEach(rd => {
      if (!rd) return;
      const key = `${rd.empNo}-${rd.date}`;
      if (!restByDate[rd.date]) restByDate[rd.date] = [];
      restByDate[rd.date].push(rd);

      // duplicate
      if (seen.has(key)) rd.conflicts.push({type:'Duplicate Entry', reason: 'Duplicate rest day entry for same employee & date.'});
      else seen.add(key);

      // missing employee
      if (!workEmpSet.has(rd.empNo)) rd.conflicts.push({type:'Missing Employee', reason: 'Employee not found in Work Schedule data.'});

      // invalid date
      const d = new Date(rd.date);
      if (isNaN(d.getTime())) rd.conflicts.push({type:'Invalid Date Format', reason: 'Date format unrecognized.'});

      // work conflict
      if (workMap.has(key)) rd.conflicts.push({type:'Work Conflict', reason:'Employee has a work schedule on same date.'});

      // weekend count
      if (/saturday|sunday/i.test(rd.day||'')) {
        const monthYear = (rd.date || '').substr(0,2) + '/' + (rd.date || '').substr(rd.date.length-4);
        const wkKey = `${rd.empNo}-${monthYear}`;
        weekendCount[wkKey] = (weekendCount[wkKey]||0) + 1;
      }
    });

    // leadership conflict
    for (const date in restByDate) {
      const leaders = restByDate[date].filter(r => LEADERSHIP_POSITIONS.includes(r.position));
      if (leaders.length > 1) leaders.forEach(l => l.conflicts.push({type:'Leadership Conflict', reason:'Multiple leaders have same rest day.'}));
    }

    // weekend limit
    for (const wkey in weekendCount) {
      if (weekendCount[wkey] > 2) {
        const [emp] = wkey.split('-');
        restDayData.filter(r => r.empNo === emp && /saturday|sunday/i.test(r.day||'')).forEach(r => {
          r.conflicts.push({type:'Weekend Limit Exceeded', reason:`${weekendCount[wkey]} weekend rest days ‚Äî maximum 2.`});
        });
      }
    }

    renderRestTable();
    updateButtonStates();
  }

  function updateButtonStates() {
    generateWorkFileBtn.disabled = workScheduleData.length === 0;
    const hasConf = restDayData.some(r => r.conflicts && r.conflicts.length>0);
    generateRestFileBtn.disabled = restDayData.length === 0 || hasConf;
  }

  /***** Paste handler (shared) *****/
  function handlePaste(e, type) {
    e.preventDefault();
    const clipboard = (e.clipboardData || window.clipboardData);
    const text = clipboard.getData('text/plain');
    const rows = parseTabular(text);
    if (!rows || rows.length===0) return;

    const { dataRows, colMap } = detectHeaderAndMap(rows);

    if (type === 'work') {
      workScheduleData = dataRows.map(r => ({
        name: r[colMap.name] || r[0] || '',
        empNo: r[colMap.empNo] || r[1] || '',
        date: normalizeDate(r[colMap.date] || r[2] || ''),
        shift: r[colMap.shift] || r[3] || '',
        day: r[colMap.day] || r[4] || '',
        position: r[colMap.position] || r[5] || ''
      })).filter(d => d.empNo && d.date);
      renderWorkTable();
    } else {
      restDayData = dataRows.map(r => ({
        empNo: r[colMap.empNo] || r[1] || '',
        name: r[colMap.name] || r[0] || '',
        date: normalizeDate(r[colMap.date] || r[2] || ''),
        day: r[colMap.day] || r[4] || r[3] || '',
        position: r[colMap.position] || r[5] || r[4] || '',
        conflicts: []
      })).filter(d => d.empNo && d.date);
      validateSchedules();
    }

    updateButtonStates();
  }

  // attach paste listeners
  workInput.addEventListener('paste', (e) => handlePaste(e,'work'));
  restInput.addEventListener('paste', (e) => handlePaste(e,'rest'));

  /***** Button handlers for generate/clear *****/
  function generateHrisFile(type) {
    const workBranch = document.getElementById('workBranchName').value.trim();
    const restBranch = document.getElementById('restBranchName').value.trim();

    if (type === 'work') {
      if (!workBranch) return showBanner('‚ö†Ô∏è Enter Work Branch Name.');
      if (workScheduleData.length === 0) return showBanner('‚ö†Ô∏è No Work Schedule data to generate.');
      const data = workScheduleData.map(r => ({ 'Employee Number': r.empNo, 'Work Date': r.date, 'Shift Code': r.shift }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'HRIS Upload');
      XLSX.writeFile(wb, `${workBranch}_WORK_SCHEDULE.xlsx`);
      showSuccess();
    } else {
      if (!restBranch) return showBanner('‚ö†Ô∏è Enter Rest Branch Name.');
      if (restDayData.length === 0) return showBanner('‚ö†Ô∏è No Rest Day data to generate.');
      // ensure no conflicts
      if (restDayData.some(r => r.conflicts && r.conflicts.length>0)) return showBanner('‚ö†Ô∏è Resolve conflicts before generating Rest Day file.');
      const data = restDayData.map(r => ({ 'Employee No': r.empNo, 'Rest Day Date': r.date }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'HRIS Upload');
      XLSX.writeFile(wb, `${restBranch}_REST_DAY_UPLOAD.xlsx`);
      showSuccess();
    }
  }

  generateWorkFileBtn.addEventListener('click', () => generateHrisFile('work'));
  generateRestFileBtn.addEventListener('click', () => generateHrisFile('rest'));

  clearWorkBtn.addEventListener('click', () => {
    workScheduleData = []; workInput.value = ''; renderWorkTable(); updateButtonStates(); showBanner('Work schedule cleared.');
  });
  clearRestBtn.addEventListener('click', () => {
    restDayData = []; restInput.value = ''; renderRestTable(); updateButtonStates(); showBanner('Rest day schedule cleared.');
  });

  /***** Monitoring logic *****/
  const defaultMonitoring = [
    { name: 'AASP ABREEZA', checked:false, uploaded:false, uploadedBy:'', remarks:'' },
    { name: 'AASP NES - ATLAS', checked:false, uploaded:false, uploadedBy:'', remarks:'' }
  ];

  function getMonitoring() { return JSON.parse(localStorage.getItem('monitoringData') || JSON.stringify(defaultMonitoring)); }
  function saveMonitoring(d) { localStorage.setItem('monitoringData', JSON.stringify(d)); }

  function renderMonitoring() {
    const data = getMonitoring();
    monitoringBody.innerHTML = data.map((b,i) => `
      <tr>
        <td class="text-left p-2">${escapeHtml(b.name)}</td>
        <td><input type="checkbox" data-index="${i}" data-field="checked" ${b.checked? 'checked':''}></td>
        <td><input type="checkbox" data-index="${i}" data-field="uploaded" ${b.uploaded? 'checked':''}></td>
        <td><input type="text" data-index="${i}" data-field="uploadedBy" value="${escapeHtml(b.uploadedBy)}" class="px-1 py-0.5"></td>
        <td><input type="text" data-index="${i}" data-field="remarks" value="${escapeHtml(b.remarks)}" class="px-1 py-0.5"></td>
        <td>${b.uploaded? '‚úÖ Done' : b.checked? 'üü° Checked' : '‚ùå Pending'}</td>
      </tr>
    `).join('');

    // attach listeners
    monitoringBody.querySelectorAll('input').forEach(inp => {
      inp.addEventListener('change', (e) => {
        const idx = Number(e.target.dataset.index);
        const field = e.target.dataset.field;
        const d = getMonitoring();
        if (e.target.type === 'checkbox') d[idx][field] = e.target.checked;
        else d[idx][field] = e.target.value;
        saveMonitoring(d);
        renderMonitoring();
        updateMonitoringStats();
      });
    });

    updateMonitoringStats();
  }

  function updateMonitoringStats(){
    const d = getMonitoring();
    const total = d.length; const checked = d.filter(x=>x.checked).length; const uploaded = d.filter(x=>x.uploaded).length;
    totalBranchesEl && (totalBranchesEl.textContent = total);
    checkedBranchesEl && (checkedBranchesEl.textContent = checked);
    uploadedBranchesEl && (uploadedBranchesEl.textContent = uploaded);
    const pct = total? Math.round((uploaded/total)*100):0; progressPercentEl && (progressPercentEl.textContent = pct + '%');
    progressBar.style.width = pct + '%';
  }

  clearMonitoringBtn.addEventListener('click', () => { if(confirm('Clear monitoring data?')){ localStorage.removeItem('monitoringData'); renderMonitoring(); } });
  exportMonitoringBtn.addEventListener('click', () => {
    const data = getMonitoring();
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Monitoring');
    const monthText = monthSelect.options[monthSelect.selectedIndex].text;
    XLSX.writeFile(wb, `Monitoring_${monthText}_${yearSelect.value}.xlsx`);
  });

  // tabs
  tabSchedule.addEventListener('click', () => { scheduleContent.classList.remove('hidden'); monitoringContent.classList.add('hidden'); tabSchedule.classList.add('bg-indigo-600','text-white'); tabMonitoring.classList.remove('bg-indigo-600','text-white'); });
  tabMonitoring.addEventListener('click', () => { monitoringContent.classList.remove('hidden'); scheduleContent.classList.add('hidden'); tabMonitoring.classList.add('bg-indigo-600','text-white'); tabSchedule.classList.remove('bg-indigo-600','text-white'); renderMonitoring(); });

  // initial UI state
  renderWorkTable(); renderRestTable(); updateButtonStates(); renderMonitoring();

}); // DOMContentLoaded
</script>

</body>
</html>
