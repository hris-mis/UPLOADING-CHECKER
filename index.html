<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Conflict Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library for Excel file generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
table {
  table-layout: auto;
  width: 100%;
  border-collapse: collapse;
}

th {
  background: linear-gradient(to right, #f9fafb, #f3f4f6);
  text-transform: uppercase;
  letter-spacing: 0.03em;
  font-size: 0.85rem;

        }
.paste-area {
  border: 2px dashed #d1d5db;
  padding: 1rem; /* ‚¨Ö slightly reduced for alignment */
  background-color: #ffffff;
  border-radius: 0.75rem;
  min-height: 300px; /* ‚¨Ö smaller so both boxes match */
  width: 100%;
  white-space: pre;
  overflow-x: auto;
  overflow-y: auto;
  color: #374151;
  cursor: text;
  font-size: 0.9rem;
  letter-spacing: 0.01em;
  border: 1px solid #d1d5db;
  border-left: 4px solid #4f46e5;
}


.paste-area:focus {
  outline: none;
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
}

/* üßæ Make tables fill full width cleanly */
.table-container {
  overflow-x: auto;
  width: 100%;
  max-width: 100%;
  margin: 0 auto;
  border-radius: 0.75rem;
  background-color: #ffffff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  transition: all 0.2s ease-in-out;
}

.table-container table {
  width: 100%;
  table-layout: auto; /* Allow flexible column widths */
}

th:nth-child(1), td:nth-child(1) { width: 14%; } /* Name */
th:nth-child(2), td:nth-child(2) { width: 10%; } /* Emp No */
th:nth-child(3), td:nth-child(3) { width: 12%; } /* Work/Rest Date */
th:nth-child(4), td:nth-child(4) { width: 11%; } /* Shift/Day */
th:nth-child(5), td:nth-child(5) { width: 11%; } /* Day */
th:nth-child(6), td:nth-child(6) { width: 14%; } /* Position (reduced width) */


th, td {
  padding: 0.85rem 1.25rem;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
  white-space: nowrap;
  font-size: 0.9rem;
}

        
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
.conflict {
  background-color: #fff7ed;
  color: #b45309;
  font-weight: 500;
  border-left: 4px solid #f59e0b;
  white-space: pre-wrap;
  word-break: break-word;
  padding: 0.75rem;
  min-width: 320px;
  max-width: 480px;
  border-radius: 0.5rem;
        }
        .weekend-rest-day {
            color: #dc2626;
            font-weight: 500;
        }
        th:first-child, td:first-child {
    position: sticky;
    left: 0;
    background-color: #fffbea; /* light yellow */
    z-index: 2;
    box-shadow: 2px 0 5px rgba(0,0,0,0.05);
}

html, body {
  overflow-x: hidden;
}

/* ‚ú® Subtle row hover animation for corporate polish */
tbody tr {
  transition: background 0.3s ease, transform 0.2s ease;
}
tbody tr:hover {
  background: #f9fafb;
  transform: scale(1.01);
}
#monitoringTable th {
  background: #f8fafc;
  color: #1e3a8a;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.03em;
}

#monitoringTable td {
  font-size: 0.85rem;
  padding: 0.5rem 0.75rem;
}

#monitoringBody tr:hover {
  background-color: #f1f5f9;
}
/* Align both input+button headers perfectly */
.flex.items-center input[type="text"] {
  min-width: 180px;
}
button#generate-work-btn, button#generate-rest-btn {
  min-width: 130px;
}
#monitoringBody td input, #monitoringBody td select {
  text-align: center;
}


    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

<div id="warning-banner"
  class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 
         bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg shadow-md 
         transition-opacity opacity-0">
</div>


<div class="max-w-[1600px] mx-auto">

    <header class="mb-10 text-center">

    <!-- üîπ Navigation Tabs -->
<div class="flex justify-center space-x-4 mb-8">
  <button id="tab-schedule" 
    class="px-6 py-2 rounded-full font-semibold bg-indigo-600 text-white shadow-md hover:bg-indigo-700 transition">
    üóìÔ∏è Schedule Checker
  </button>
    <button id="tab-monitoring"
    class="px-6 py-2 rounded-full font-semibold bg-gray-200 text-gray-700 hover:bg-indigo-100 transition">
    üìä Monitoring
  </button>

  
</header>

        <!-- Success Message -->
<div id="success-message"
  class="hidden fixed top-6 right-6 bg-gradient-to-r from-green-600 to-emerald-600 text-white 
         py-3 px-6 rounded-lg shadow-lg font-medium transition-transform transform translate-x-full">
  ‚úÖ Validation successful! HRIS upload file has been generated.
</div>

<!-- ‚úÖ Schedule Checker Tab -->
<div id="tab-schedule-content" class="hidden">
    <h1 class="text-4xl font-extrabold bg-gradient-to-r from-indigo-700 to-blue-500 text-transparent bg-clip-text text-center mt-4">
    Schedule Conflict Checker
  </h1>
  <p class="mt-2 text-gray-600 text-sm tracking-wide text-center mb-6">
    Validate, review, and export work & rest day schedules with ease.
  </p>


<!-- üü¶ WIDER SIDE-BY-SIDE LAYOUT -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch">

  <!-- Work Schedule Section -->
  <div class="bg-white p-6 rounded-lg shadow-sm">
    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
      <h2 class="text-xl font-semibold text-gray-700">1. Paste Work Schedule Data</h2>
      <div class="flex items-center">
        <input type="text" id="work-branch-name" placeholder="Enter Branch Name"
          class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 mr-2">
        <button id="generate-work-btn" onclick="generateHrisFile('work')"
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap">
          Generate File
        </button>
      </div>
    </div>

    <div id="work-schedule-paste" contenteditable="true" class="paste-area" onpaste="handlePaste(event, 'work')"></div>

    <div class="table-container mt-4">
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
<th class="px-2 py-2 text-xs">Name</th>
<th class="px-2 py-2 text-xs">Emp No.</th>
<th class="px-2 py-2 text-xs">Work Date</th>
<th class="px-2 py-2 text-xs">Shift</th>
<th class="px-2 py-2 text-xs">Day</th>
<th class="px-2 py-2 text-xs">Position</th>

          </tr>
        </thead>
        <tbody id="work-schedule-body">
          <!-- JS will populate this -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Rest Day Schedule Section -->
<div class="bg-white p-6 rounded-lg shadow-sm mt-8">
  <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
<div class="flex flex-wrap justify-between items-center gap-4 mb-4">
  <h2 class="text-xl font-semibold text-gray-700">2. Paste Rest Day Schedule Data</h2>
  <div class="flex items-center">
    <input type="text" id="rest-branch-name" placeholder="Enter Branch Name"
      class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 mr-2" />
    <button id="generate-rest-btn" onclick="generateHrisFile('rest')"
      class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors whitespace-nowrap">
      üìÑ Generate File
    </button>
  </div>
</div>

<div id="rest-day-paste" contenteditable="true"
class="paste-area border border-gray-300 rounded-md p-4 min-h-[300px] text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 mx-auto w-full"
  onpaste="handlePaste(event, 'rest')"></div>

<p class="text-xs text-gray-500 mt-2">Paste your Rest Day data here.</p>

<div id="restDayTableContainer" class="mt-6 overflow-x-auto"></div>


<!-- Table -->
<div class="table-container mt-4">
  <table class="min-w-full divide-y divide-gray-200">
    <thead>
      <tr>
        <th class="px-2 py-2 text-xs">Conflict</th>
        <th class="px-2 py-2 text-xs">Name</th>
        <th class="px-2 py-2 text-xs">Emp No.</th>
        <th class="px-2 py-2 text-xs">Rest Date</th>
        <th class="px-2 py-2 text-xs">Day</th>
        <th class="px-2 py-2 text-xs">Position</th>
      </tr>
    </thead>
    <tbody id="rest-day-body">
      <!-- JS will populate this -->
    </tbody>
  </table>
  <p id="summary" class="mt-4 text-sm font-medium text-gray-700"></p>
</div>


        <!-- Important Notices -->
        <div class="bg-white p-6 rounded-lg shadow-sm border border-yellow-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Important Notices</h3>
            <ul class="space-y-3 text-gray-600">
                <li><strong class="font-semibold text-yellow-800">1:</strong> Branch Heads, Site Supervisors, and OICs are strictly prohibited from taking rest days on the same date.</li>
                <li><strong class="font-semibold text-yellow-800">2:</strong> Validation is based on Employee Number, Rest Day, and Work Date. Ensure Employee Numbers are entered correctly for accurate conflict detection.</li>
                <li><strong class="font-semibold text-yellow-800">3:</strong> Leaders and Team Members can only take a maximum of 2 weekend Rest Days per month.</li>
            </ul>
        </div>
    </div>

    
</div> <!-- ‚úÖ close the grid layout for Schedule Checker -->

</div> <!-- ‚úÖ close tab-schedule-content container -->

<!-- ‚úÖ MONITORING TAB -->
<div id="tab-monitoring-content" class="hidden p-6">
  <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">üìä Branch Monitoring Dashboard</h2>
  <div class="flex justify-center mb-6 mt-4">
  <button id="clearMonitoringBtn"
    class="bg-red-500 hover:bg-red-600 text-white font-semibold px-6 py-2 rounded-lg shadow">
    üßπ Clear All Data
  </button>
</div>



  <!-- Progress summary -->
  <div class="text-center text-gray-700 mb-4">
    <p>Total Branches: <span id="totalBranches">0</span> |
       Checked: <span id="checkedBranches">0</span> |
       Uploaded: <span id="uploadedBranches">0</span> |
       Progress: <span id="progressPercent">0%</span></p>
    <div class="w-1/2 mx-auto bg-gray-200 rounded-full h-3 mt-2">
      <div id="progressBar" class="h-3 bg-green-500 rounded-full w-0"></div>
    </div>
  </div>

<!-- üîπ Branch Controls -->
<div class="flex flex-wrap justify-center gap-3 mb-4">
  <input id="newBranchName" type="text" placeholder="Enter new branch name"
    class="border border-gray-300 rounded-md px-3 py-2 w-60 focus:ring-2 focus:ring-indigo-500">
  <button id="addBranchBtn"
    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg">‚ûï Add Branch</button>
  <button id="editBranchBtn"
    class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-4 py-2 rounded-lg">‚úèÔ∏è Edit Branches</button>
</div>

<!-- üîç Search -->
<div class="flex justify-center mb-4">
  <input id="monitoringSearch" type="text" placeholder="Search branch..."
    class="border border-gray-300 rounded-md px-3 py-2 w-64 focus:ring-2 focus:ring-indigo-500">
</div>


  <!-- Branch Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-300 rounded-lg text-sm text-center align-middle table-auto">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-2 text-left">Branch</th>
          <th class="p-2 text-center">Check</th>
          <th class="p-2 text-center">Upload</th>
          <th class="p-2 text-center">Uploaded By</th>
          <th class="p-2 text-center">Remarks</th>
          <th class="p-2 text-center">Progress</th>
        </tr>
      </thead>
      <tbody id="monitoringBody"></tbody>
    </table>
  </div>

  <!-- Export -->
  <div class="flex justify-center mt-6">
    <button id="exportMonitoringBtn"
      class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-2 rounded-lg shadow">
      üì§ Export Monitoring (Excel)
    </button>
  </div>
</div>


<!-- Monitoring branch progress area -->
<div class="mt-4">
  <div class="flex items-center space-x-4 mb-4">
    <select id="monthSelect" class="border rounded-lg px-3 py-2 text-sm">
      <option value="2025-10">October 2025</option>
      <option value="2025-11">November 2025</option>
      <option value="2025-12">December 2025</option>
    </select>

    <select id="uploaderSelect" class="border rounded-lg px-3 py-2 text-sm">
      <option value="">All Uploaders</option>
      <option value="Claire">Claire</option>
      <option value="Melvin">Melvin</option>
      <option value="Joy">Joy</option>
    </select>
  </div>

  <script>




// ‚úÖ Default tab setup (Schedule Checker first)
window.addEventListener('DOMContentLoaded', () => {
  // Show Schedule Checker first, hide Monitoring
  const scheduleTab = document.getElementById('tab-schedule-content');
  const monitoringTab = document.getElementById('tab-monitoring-content');

  if (scheduleTab && monitoringTab) {
    scheduleTab.classList.remove('hidden');
    monitoringTab.classList.add('hidden');

    loadMonitoringData();
updateMonitoringProgress();

  }

  document.getElementById('tab-schedule').classList.add('bg-indigo-600', 'text-white');
  document.getElementById('tab-monitoring').classList.remove('bg-indigo-600', 'text-white');
  document.getElementById('tab-monitoring').classList.add('bg-gray-200', 'text-gray-700');
});


    // Data stores
    let workScheduleData = [];
    let restDayData = [];

    const LEADERSHIP_POSITIONS = ['Branch Head', 'Site Supervisor', 'OIC'];

    // --- PASTE AND PARSE LOGIC ---
function handlePaste(e, type) {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text/plain');

    e.target.innerText = '';

    const allRows = text.trim().split('\n').map(row => row.split('\t'));

    // ‚úÖ Check if first row is a merged header like "WORK SCHEDULE" or "REST DAY SCHEDULE"
    const hasMergedHeader = allRows[0].length === 1 && 
        (allRows[0][0].toLowerCase().includes('work schedule') || allRows[0][0].toLowerCase().includes('rest day schedule'));

    // ‚úÖ Skip 1 or 2 rows if necessary (title row + column headers)
    const rows = hasMergedHeader ? allRows.slice(2) : allRows.slice(1); 

if (type === 'work') {
    workScheduleData = rows.map(row => {
        let name = '', empNo = '';

        // üîç Detect column order automatically
        if (/^\d+$/.test(row[0]?.trim())) {
            empNo = row[0];
            name = row[1];
        } else {
            name = row[0];
            empNo = row[1];
        }

        return {
            name: name || '',
            empNo: empNo || '',
            date: row[2] ? normalizeDate(row[2]) : '',
            shift: row[3] || '',
            day: row[4] || '',
            position: row[5] || ''
        };
    }).filter(d => d.empNo && d.date);
    renderWorkTable();

} else if (type === 'rest') {
    restDayData = rows.map(row => {
        let name = '', empNo = '';

        // üîç Detect column order automatically
        if (/^\d+$/.test(row[0]?.trim())) {
            empNo = row[0];
            name = row[1];
        } else {
            name = row[0];
            empNo = row[1];
        }

        return {
            empNo: empNo || '',
            name: name || '',
            date: row[2] ? normalizeDate(row[2]) : '',
            day: row[3] || '',
            position: row[4] || '',
            conflicts: []
        };
    }).filter(d => d.empNo && d.date);
}
    validateSchedules();
    
    function normalizeDate(dateString) {
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}/${day}/${year}`;
        } catch(e) {
            return dateString;
        }
    }

    // --- RENDERING LOGIC ---
    function renderWorkTable() {
        const tbody = document.getElementById('work-schedule-body');
        tbody.innerHTML = workScheduleData.map(d => `
            <tr>
                <td>${d.name}</td>
                <td>${d.empNo}</td>
                <td>${d.date}</td>
                <td>${d.shift}</td>
                <td>${d.day}</td>
                <td>${d.position}</td>
            </tr>
        `).join('');
    }

function renderRestDayTable() {
    const tbody = document.getElementById('rest-day-body');
    tbody.innerHTML = restDayData.map(d => {
        const isWeekend = d.day === 'Saturday' || d.day === 'Sunday';
        const hasConflict = d.conflicts.length > 0;
        const rowHighlight = hasConflict ? 'bg-yellow-50 border-l-4 border-yellow-400' : '';
        const conflictMessages = d.conflicts.map(c => `<div><strong>${c.type}:</strong> ${c.reason}</div>`).join('');

        return `
            <tr class="${rowHighlight}">
                <td class="font-medium text-red-600 max-w-xs overflow-y-auto whitespace-pre-line">
                    ${conflictMessages || ''}
                </td>
                <td>${d.name}</td>
                <td>${d.empNo}</td>
                <td class="${isWeekend ? 'weekend-rest-day' : ''}">${d.date}</td>
                <td class="${isWeekend ? 'weekend-rest-day' : ''}">${d.day}</td>
                <td>${d.position}</td>
            </tr>
        `;
    }).join('');

    // ‚úÖ Move summary counter here (after rendering)
    const total = restDayData.length;
    const conflicts = restDayData.filter(d => d.conflicts && d.conflicts.length > 0).length;
    document.getElementById('summary').innerText =
      `${conflicts} out of ${total} entries have conflicts detected.`;

      if (conflicts === 0 && total > 0) {
  document.getElementById('summary').classList.add('text-green-600');
  document.getElementById('summary').innerText = `‚úÖ No conflicts detected for ${total} entries.`;
} else {
  document.getElementById('summary').classList.remove('text-green-600');
}

}
    
    // --- BUTTON AND STATE MANAGEMENT ---
    function updateButtonStates() {
        const workBtn = document.getElementById('generate-work-btn');
        const restBtn = document.getElementById('generate-rest-btn');

        workBtn.disabled = workScheduleData.length === 0;

        const hasConflicts = restDayData.some(d => d.conflicts.length > 0);
        restBtn.disabled = restDayData.length === 0 || hasConflicts;
    }

    // --- VALIDATION LOGIC ---
function validateSchedules() {
    if (workScheduleData.length > 0 || restDayData.length > 0) {
        restDayData.forEach(rd => rd.conflicts = []);

        const workScheduleMap = new Map(workScheduleData.map(ws => [`${ws.empNo}-${ws.date}`, ws]));
        const empNumbersInWork = new Set(workScheduleData.map(ws => ws.empNo));
        const restDaysByDate = {};
        const weekendRestDaysByEmployee = {};
        const seenRestEntries = new Set();

        restDayData.forEach(rd => {
            if (!restDaysByDate[rd.date]) restDaysByDate[rd.date] = [];
            restDaysByDate[rd.date].push(rd);

            // --- Weekend Count ---
            const isWeekend = rd.day === 'Saturday' || rd.day === 'Sunday';
            if (isWeekend) {
                const monthYear = rd.date.substring(0, 2) + '/' + rd.date.substring(6, 10);
                const key = `${rd.empNo}-${monthYear}`;
                if (!weekendRestDaysByEmployee[key]) weekendRestDaysByEmployee[key] = 0;
                weekendRestDaysByEmployee[key]++;
            }

            // --- Duplicate Entry Check ---
            const uniqueKey = `${rd.empNo}-${rd.date}`;
            if (seenRestEntries.has(uniqueKey)) {
                rd.conflicts.push({ type: 'Duplicate Entry', reason: 'Duplicate rest day entry found for same employee and date.' });
            } else {
                seenRestEntries.add(uniqueKey);
            }

            // --- Invalid Date Format ---
            const d = new Date(rd.date);
            if (isNaN(d.getTime())) {
                rd.conflicts.push({ type: 'Invalid Date Format', reason: 'Date format unrecognized or invalid.' });
            }

            // --- Missing Employee Check ---
            if (!empNumbersInWork.has(rd.empNo)) {
                rd.conflicts.push({ type: 'Missing Employee', reason: 'Employee found in Rest Day sheet but not in Work Schedule data.' });
            }

            // --- Work Conflict ---
            if (workScheduleMap.has(uniqueKey)) {
                rd.conflicts.push({ type: 'Work Conflict', reason: 'Employee has a work schedule on the same date as their rest day.' });
            }
        });

        // --- Leadership Conflict ---
        for (const date in restDaysByDate) {
            const leadersOnRest = restDaysByDate[date].filter(rd => LEADERSHIP_POSITIONS.includes(rd.position));
            if (leadersOnRest.length > 1) {
                leadersOnRest.forEach(rd => {
                    rd.conflicts.push({ type: 'Leadership Conflict', reason: 'Multiple leaders (Branch Head/Supervisor/OIC) have the same rest day.' });
                });
            }
        }
// --- Weekend Pair Validation (optional enhancement) ---
const weekendPairs = [
    ['Thursday', 'Friday'],
    ['Friday', 'Saturday'],
    ['Saturday', 'Sunday'],
    ['Sunday', 'Monday']
];

const groupedByEmp = {};
restDayData.forEach(rd => {
    if (!groupedByEmp[rd.empNo]) groupedByEmp[rd.empNo] = [];
    groupedByEmp[rd.empNo].push(rd);
});

Object.keys(groupedByEmp).forEach(empNo => {
    const empDays = groupedByEmp[empNo];
    const dayNames = empDays.map(d => d.day);
    let detectedPairs = new Set();

    weekendPairs.forEach(([a, b]) => {
        if (dayNames.includes(a) && dayNames.includes(b)) {
            detectedPairs.add(`${a}-${b}`);
        }
    });

    const hasFriday = dayNames.includes('Friday');
    const hasSaturday = dayNames.includes('Saturday');
    const hasWeekday = dayNames.some(d => !['Friday','Saturday','Sunday'].includes(d));
    if (hasFriday && hasWeekday) detectedPairs.add('Friday + Weekday');
    if (hasSaturday && hasWeekday) detectedPairs.add('Saturday + Weekday');

    if (detectedPairs.size > 2) {
        const reason = `Weekend Limit Exceeded: ${detectedPairs.size} weekend RDs (${[...detectedPairs].join(', ')})`;
        empDays.forEach(d => {
            d.conflicts.push({ type: 'Weekend Pair Violation', reason });
        });
    }
});

        // --- Weekend Limit Exceeded ---
        for (const key in weekendRestDaysByEmployee) {
            if (weekendRestDaysByEmployee[key] > 2) {
                const [empNo, monthYear] = key.split('-');
                restDayData.forEach(rd => {
                    const rdMonthYear = rd.date.substring(0, 2) + '/' + rd.date.substring(6, 10);
                    const isWeekend = rd.day === 'Saturday' || rd.day === 'Sunday';
                    if (rd.empNo === empNo && rdMonthYear === monthYear && isWeekend) {
                        rd.conflicts.push({
                            type: 'Weekend Limit Exceeded',
                            reason: `${weekendRestDaysByEmployee[key]} weekend rest days found ‚Äî maximum allowed is 2.`
                        });
                    }
                });
            }
        }
    }

    // ‚úÖ Scroll to first conflict if any
const firstConflict = restDayData.find(rd => rd.conflicts.length > 0);
if (firstConflict) {
  setTimeout(() => {
    const row = document.querySelector('td.font-medium.text-red-600');
    if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 200);
}

    renderRestDayTable();
    updateButtonStates();
}
}
// --- FILE GENERATION ---
function generateHrisFile(type) {
  const banner = document.getElementById('warning-banner');

  function showBanner(message) {
    banner.textContent = message;
    banner.classList.remove('hidden');
    banner.classList.add('opacity-100');
    setTimeout(() => {
      banner.classList.remove('opacity-100');
      setTimeout(() => banner.classList.add('hidden'), 500);
    }, 4000);
  }

  let branchName = '';
  let data = [];
  let filename = '';

  if (type === 'work') {
    branchName = document.getElementById('work-branch-name').value.trim();
    if (!branchName) {
      showBanner("‚ö†Ô∏è Please enter the Work Branch Name before generating the file.");
      return;
    }
    if (workScheduleData.length === 0) {
      showBanner("‚ö†Ô∏è No Work Schedule data found. Please paste it first.");
      return;
    }

    data = workScheduleData.map(item => ({
      'Employee Number': item.empNo,
      'Work Date': item.date,
      'Shift Code': item.shift || ''
    }));

    filename = `${branchName}_WORK_SCHEDULE.xlsx`;
  }

  else if (type === 'rest') {
    branchName = document.getElementById('rest-branch-name').value.trim();
    if (!branchName) {
      showBanner("‚ö†Ô∏è Please enter the Rest Branch Name before generating the file.");
      return;
    }
    if (restDayData.length === 0) {
      showBanner("‚ö†Ô∏è No Rest Day Schedule data found. Please paste it first.");
      return;
    }

    data = restDayData.map(item => ({
      'Employee No': item.empNo,
      'Rest Day Date': item.date
    }));

    const defaultFilename = 'REST_DAY_UPLOAD.xlsx';
    filename = branchName ? `${branchName}_${defaultFilename}` : defaultFilename;
  }

  else {
    showBanner("‚ö†Ô∏è Invalid generation type.");
    return;
  }

  // ‚úÖ Generate Excel file
  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'HRIS Upload');
  XLSX.writeFile(workbook, filename);

  // ‚úÖ Show success message
  showSuccessMessage();
}

// --- SUCCESS MESSAGE ---
function showSuccessMessage() {
  const msg = document.getElementById('success-message');
  msg.classList.remove('hidden', 'translate-x-full');
  msg.classList.add('translate-x-0');
  setTimeout(() => {
    msg.classList.remove('translate-x-0');
    msg.classList.add('translate-x-full');
    setTimeout(() => msg.classList.add('hidden'), 300);
  }, 3000);
}

// --- CLEAR ALL DATA ---
function clearAllData() {
  workScheduleData = [];
  restDayData = [];
  document.getElementById('work-schedule-paste').innerText = '';
  document.getElementById('rest-day-paste').innerText = '';
  document.getElementById('work-branch-name').value = '';
  document.getElementById('rest-branch-name').value = '';
  document.getElementById('summary').innerText = '';
  document.getElementById('summary').classList.remove('text-green-600');
  renderWorkTable();
  renderRestDayTable();
  updateButtonStates();

  // üßπ Optional: show confirmation banner
  const banner = document.getElementById('warning-banner');
  banner.textContent = "üßπ All data cleared successfully.";
  banner.classList.remove('hidden');
  banner.classList.add('opacity-100');
  setTimeout(() => {
    banner.classList.remove('opacity-100');
    setTimeout(() => banner.classList.add('hidden'), 500);
  }, 3000);
}

// TAB SWITCHING LOGIC
document.getElementById('tab-schedule').addEventListener('click', () => {
  // Show Schedule tab content and hide Monitoring content
  document.getElementById('tab-schedule-content').classList.remove('hidden');
  document.getElementById('tab-monitoring-content').classList.add('hidden');

  // Update button styling for active tab
  document.getElementById('tab-schedule').classList.add('bg-indigo-600', 'text-white');
  document.getElementById('tab-monitoring').classList.remove('bg-indigo-600', 'text-white');
  document.getElementById('tab-monitoring').classList.add('bg-gray-200', 'text-gray-700');
});


document.getElementById('tab-monitoring').addEventListener('click', () => {
  // Show Monitoring tab content and hide Schedule content
  document.getElementById('tab-monitoring-content').classList.remove('hidden');
  document.getElementById('tab-schedule-content').classList.add('hidden');

  // Update button styling for active tab
  document.getElementById('tab-monitoring').classList.add('bg-indigo-600', 'text-white');
  document.getElementById('tab-schedule').classList.remove('bg-indigo-600', 'text-white');
  document.getElementById('tab-schedule').classList.add('bg-gray-200', 'text-gray-700');
});


// --- Placeholder functions for future add/edit ---
function addBranch() {
  alert('üü¢ Add Branch feature coming soon!');
}

function editBranches() {
  alert('‚úèÔ∏è Edit Branches feature coming soon!');
}

/* --- MONITORING TAB LOCAL SAVE (Per Month Version) --- */
const monitoringBody = document.getElementById("monitoringBody");
const monthSelect = document.getElementById("monthSelect");

function getStorageKey() {
  return `branchMonitoring_${monthSelect.value}`;
}
document.getElementById("clearMonitoringBtn").addEventListener("click", () => {
  if (!confirm("Clear all monitoring data for this month?")) return;
  localStorage.removeItem(getStorageKey());
  initializeMonitoringTable();
  updateMonitoringProgressBar();
});

// üîπ Initialize monitoring table when page loads
window.addEventListener("DOMContentLoaded", () => {
  loadMonitoringData();
  updateMonitoringProgress();
});

// üîπ Also refresh table when month is changed
monthSelect.addEventListener("change", () => {
  loadMonitoringData();
});



// üîπ Load saved data when page opens or month changes
function loadMonitoringData() {
  const key = getStorageKey();
  let data = JSON.parse(localStorage.getItem(key)) || [];

  // üü¶ If empty, initialize defaults
  if (data.length === 0) {
    initializeMonitoringTable();
    return;
  }

  renderMonitoringTable(data);
  updateMonitoringProgress();
}


// üîπ Save data to localStorage
function saveMonitoringData() {
  const data = [...document.querySelectorAll("#monitoringBody tr")].map(tr => {
    const tds = tr.querySelectorAll("td");
    return {
      branch: tds[0].innerText,
      checked: tds[1].querySelector("input")?.checked || false,
      uploaded: tds[2].querySelector("input")?.checked || false,
      uploadedBy: tds[3].querySelector("select")?.value || "",
      remarks: tds[4].querySelector("input")?.value || ""
    };
  });

  localStorage.setItem(getStorageKey(), JSON.stringify(data));
  renderMonitoringTable(data);
  updateMonitoringProgress();
}

// üü£ Add Branch Logic
document.getElementById("addBranchBtn").addEventListener("click", () => {
  const name = document.getElementById("newBranchName").value.trim();
  if (!name) return alert("Please enter a branch name.");
  const data = JSON.parse(localStorage.getItem(getStorageKey()) || "[]");
  if (data.some(b => b.branch.toLowerCase() === name.toLowerCase())) {
    alert("Branch already exists!");
    return;
  }
  data.push({ branch: name, checked: false, uploaded: false, uploadedBy: "", remarks: "" });
  localStorage.setItem(getStorageKey(), JSON.stringify(data));
  renderMonitoringTable(data);
  document.getElementById("newBranchName").value = "";
});

// üü¢ Export Monitoring Data to Excel
document.getElementById("exportMonitoringBtn").addEventListener("click", () => {
  const key = getStorageKey();
  const data = JSON.parse(localStorage.getItem(key)) || [];

  if (data.length === 0) {
    alert("No monitoring data to export for this month.");
    return;
  }

  const exportData = data.map(item => ({
    Branch: item.branch,
    Checked: item.checked ? "‚úÖ Yes" : "‚ùå No",
    Uploaded: item.uploaded ? "‚úÖ Yes" : "‚ùå No",
    "Uploaded By": item.uploadedBy || "",
    Remarks: item.remarks || ""
  }));

  const worksheet = XLSX.utils.json_to_sheet(exportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Monitoring");
  const filename = `${monthSelect.value}_Branch_Monitoring.xlsx`;
  XLSX.writeFile(workbook, filename);
});


// üü° Edit Branch Placeholder
document.getElementById("editBranchBtn").addEventListener("click", () => {
  alert("‚úèÔ∏è Edit Branches feature coming soon!");
});


// üîπ Render table dynamically
function renderMonitoringTable(data) {
const tableBody = document.getElementById("monitoringBody");
  tableBody.innerHTML = "";

  data.forEach((item, index) => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${item.branch}</td>
      <td style="text-align:center;"><input type="checkbox" class="chk-checked" data-index="${index}" ${item.checked ? "checked" : ""}></td>
      <td style="text-align:center;"><input type="checkbox" class="chk-uploaded" data-index="${index}" ${item.uploaded ? "checked" : ""}></td>
      <td>
        <select class="uploader" data-index="${index}">
          <option value="">--Select--</option>
          <option ${item.uploadedBy === "Joy" ? "selected" : ""}>Joy</option>
          <option ${item.uploadedBy === "Melvin" ? "selected" : ""}>Melvin</option>
          <option ${item.uploadedBy === "Claire" ? "selected" : ""}>Claire</option>
        </select>
      </td>
      <td><input type="text" class="remarks" data-index="${index}" value="${item.remarks || ""}"></td>
    `;

    tableBody.appendChild(row);
  });

  // üü© Event listeners
  document.querySelectorAll(".chk-checked, .chk-uploaded, .uploader, .remarks").forEach(el => {
    el.addEventListener("change", saveMonitoringData);
  });
}

function updateMonitoringProgress() {
  const key = getStorageKey();
  const data = JSON.parse(localStorage.getItem(key)) || [];

  const total = data.length;
  const checked = data.filter(d => d.checked).length;
  const uploaded = data.filter(d => d.uploaded).length;

  const percent = total > 0 ? ((checked + uploaded) / (total * 2)) * 100 : 0;

  document.getElementById("totalBranches").textContent = total;
  document.getElementById("checkedBranches").textContent = checked;
  document.getElementById("uploadedBranches").textContent = uploaded;
  document.getElementById("progressPercent").textContent = percent.toFixed(1) + "%";

  const bar = document.getElementById("progressBar");
  bar.style.width = `${percent}%`;
  bar.textContent = `${percent.toFixed(1)}%`;
}





// üîç SEARCH FUNCTIONALITY
document.getElementById("monitoringSearch").addEventListener("input", (e) => {
  const term = e.target.value.toLowerCase();
const all = JSON.parse(localStorage.getItem(getStorageKey()) || "[]");
  const filtered = all.filter(b => b.branch.toLowerCase().includes(term));
  renderMonitoringTable(filtered);
});


// üîπ Default monitoring setup for all branches
function initializeMonitoringTable() {
  const data = [
    { branch: "AASP CEBU", checked: false, uploaded: false, uploadedBy: "", remarks: "" },
    { branch: "AASP CLARK", checked: false, uploaded: false, uploadedBy: "", remarks: "" },
    { branch: "AASP ABREEZA", checked: false, uploaded: false, uploadedBy: "", remarks: "" },
    { branch: "AASP NES - ATLAS", checked: false, uploaded: false, uploadedBy: "", remarks: "" },
    { branch: "AASP ANNEX", checked: false, uploaded: false, uploadedBy: "", remarks: "" },
    // üî∏ add more branches here, same format:
    // { branch: "AASP DAVAO", checked: false, uploaded: false, uploadedBy: "", remarks: "" },
  ];
  localStorage.setItem(getStorageKey(), JSON.stringify(data));
  renderMonitoringTable(data);
  updateMonitoringProgress();
}


// ‚úÖ Ensure monitoring table loads properly
monthSelect.addEventListener("change", loadMonitoringData);
window.addEventListener("DOMContentLoaded", loadMonitoringData);


monthSelect.addEventListener("change", () => {
  loadMonitoringData();
});

// üîπ Load on page open
window.addEventListener("load", loadMonitoringData);

// üîπ Export monitoring table to Excel
document.getElementById("exportMonitoringBtn").addEventListener("click", () => {
  const rows = [...document.querySelectorAll("#monitoringBody tr")].map(tr => {
    const tds = tr.querySelectorAll("td");
    return {
      Branch: tds[0].innerText,
      Checked: tds[1].querySelector("input").checked ? "Yes" : "No",
      Uploaded: tds[2].querySelector("input").checked ? "Yes" : "No",
      "Uploaded By": tds[3].querySelector("select").value,
      Remarks: tds[4].querySelector("input").value,
      Status: tds[5].innerText
    };
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Monitoring");
  const month = document.getElementById("monthSelect").value;
  XLSX.writeFile(wb, `Branch_Monitoring_${month}.xlsx`);
});

window.addEventListener("DOMContentLoaded", () => {
  loadMonitoringData();
  updateMonitoringProgress();
});



</script>
</div>
</body>
</html>