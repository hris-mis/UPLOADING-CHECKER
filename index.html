<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Schedule Conflict Checker ‚Äî Fixed</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
<!-- Library for Excel file generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* ============================
   üåä TECH BREEZE LIGHT THEME
   Glassmorphic + Animated Edition
   ‚Äî Blue‚ÄìTeal Premium ‚Äî
============================ */

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #e0f7fa, #f0fdfa, #f9fafb);
  background-size: 200% 200%;
  color: #0f172a;
  min-height: 100vh;
  overflow-x: hidden;
  transition: background 1s ease;
}

/* ‚ú® Floating Particles Container */
#particle-container {
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 0;
}

/* üå´Ô∏è Glass Cards */
.dashboard-card {
  position: relative;
  background: rgba(255, 255, 255, 0.55);
  backdrop-filter: blur(16px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 1rem;
  box-shadow: 0 8px 32px rgba(13, 148, 136, 0.1);
  padding: 1.5rem;
  transition: all 0.4s ease;
  z-index: 1;
}
.dashboard-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(13, 148, 136, 0.25);
  border-color: rgba(13, 148, 136, 0.3);
}

/* ü™∂ Paste Area */
.paste-area {
  border: 2px dashed rgba(45, 212, 191, 0.5);
  background: rgba(240, 253, 250, 0.65);
  padding: 1rem;
  border-radius: 0.75rem;
  min-height: 260px;
  width: 100%;
  white-space: pre;
  overflow: auto;
  font-size: 0.9rem;
  color: #0f766e;
  cursor: text;
  transition: all 0.3s ease;
}
.paste-area:focus {
  outline: none;
  border-color: #0d9488;
  box-shadow: 0 0 12px rgba(45, 212, 191, 0.4);
  background: rgba(255, 255, 255, 0.9);
}

/* üåà Header */
header {
  background: linear-gradient(90deg, #0ea5e9, #14b8a6, #06b6d4);
  background-size: 300% 300%;
  color: white;
  padding: 1.5rem 0;
  border-radius: 1rem;
  box-shadow: 0 4px 25px rgba(14,165,233,0.25);
  position: relative;
  overflow: hidden;
  z-index: 2;
}
header {
  position: sticky;
  top: 0;
  z-index: 20;
}
header::before {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.25), transparent 70%);
  opacity: 0.7;
  animation: headerGlow 6s ease-in-out infinite alternate;
}
@keyframes headerGlow {
  from { transform: translateX(0); opacity: 0.6; }
  to { transform: translateX(50px); opacity: 1; }
}

/* üå§Ô∏è Typography */
h1, h2 {
  font-weight: 800;
  background: linear-gradient(to right, #0ea5e9, #14b8a6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
h3 {
  color: #0369a1;
  font-weight: 700;
}

/* üìä Tables */
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto;
  background: rgba(255,255,255,0.5);
  border-radius: 0.75rem;
  overflow: hidden;
  backdrop-filter: blur(10px);
}
th, td {
  padding: 0.75rem 1rem;
  text-align: left;
  border-bottom: 1px solid rgba(14,165,233,0.15);
}
th {
  background: rgba(240,249,255,0.9);
  color: #0c4a6e;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
tr:hover {
  background: rgba(240,249,255,0.7);
  transform: scale(1.005);
  transition: all 0.2s ease;
}
th:first-child, td:first-child {
  position: sticky;
  left: 0;
  background: rgba(240,249,255,0.95);
  z-index: 2;
}

/* ‚ö†Ô∏è Conflict Row */
.conflict-row {
  animation: pulseConflict 2s ease-in-out infinite;
}
@keyframes pulseConflict {
  0%, 100% { background-color: rgba(254, 243, 199, 0.8); }
  50% { background-color: rgba(253, 230, 138, 0.9); }
}

/* ‚úÖ Summary Boxes */
.summary-box {
  background: linear-gradient(90deg, #ecfdf5, #f0fdfa);
  color: #065f46;
  border-left: 4px solid #14b8a6;
  padding: 0.75rem 1rem;
  border-radius: 0.5rem;
  margin-top: 1rem;
  box-shadow: 0 2px 12px rgba(13,148,136,0.1);
}

/* üéõÔ∏è Buttons */
.btn {
  font-weight: 600;
  border-radius: 0.75rem;
  padding: 0.6rem 1.2rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}
.btn-primary {
  background: linear-gradient(90deg, #0ea5e9, #14b8a6);
  color: white;
  box-shadow: 0 4px 15px rgba(14,165,233,0.25);
}
.btn-primary:hover {
  background-position: 100% 0;
  box-shadow: 0 8px 25px rgba(14,165,233,0.35);
  transform: translateY(-2px);
}
.btn-secondary {
  background: rgba(240,249,255,0.9);
  color: #0369a1;
}
.btn-danger {
  background: linear-gradient(90deg, #f43f5e, #fb7185);
  color: white;
}
.btn-success {
  background: linear-gradient(90deg, #10b981, #34d399);
  color: white;
}

/* üí¨ Toast Notifications */
.toast {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(12px);
  padding: 1rem 1.25rem;
  border-radius: 0.75rem;
  box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  min-width: 260px;
  font-weight: 600;
  opacity: 0;
  transform: translateY(20px);
  animation: toastSlideIn 0.6s ease forwards, toastFadeOut 0.5s ease 4s forwards;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.toast.success { border-left: 4px solid #10b981; color: #065f46; }
.toast.error { border-left: 4px solid #ef4444; color: #991b1b; }
@keyframes toastSlideIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes toastFadeOut {
  to { opacity: 0; transform: translateY(10px); }
}
/* üîù Fix toast & banner visibility */
#warning-banner,
#success-message,
.toast {
  z-index: 9999 !important;
}

/* üåà Scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #0ea5e9, #14b8a6);
  border-radius: 4px;
}
::-webkit-scrollbar-track {
  background: rgba(240,249,255,0.5);
}

/* ü©µ Animations for sections */
.fade-in {
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.8s ease forwards;
}
@keyframes fadeInUp {
  to { opacity: 1; transform: translateY(0); }
}
.dashboard-card { transition: transform 0.4s ease, box-shadow 0.4s ease, border-color 0.3s ease; }
@keyframes fadeInOut {
  0% { opacity: 0; transform: translateY(10px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(10px); }
}
</style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

<div id="warning-banner" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg shadow-md transition-opacity opacity-0"></div>
<div id="success-message" class="hidden fixed top-16 left-1/2 transform -translate-x-1/2 bg-green-100 text-green-800 px-4 py-2 rounded-lg shadow-md transition-opacity opacity-0">‚úÖ File generated successfully!</div>
<div class="max-w-[1400px] mx-auto">
  <header class="mb-10 text-center">
    <div class="flex justify-center space-x-4 mb-8">
      <button id="tab-schedule" class="px-6 py-2 rounded-full font-semibold bg-indigo-600 text-white shadow-md hover:bg-indigo-700 transition">üóìÔ∏è Schedule Checker</button>
      <button id="tab-monitoring" class="px-6 py-2 rounded-full font-semibold bg-gray-200 text-gray-700 hover:bg-indigo-100 transition">üìä Monitoring</button>
    </div>
  </header>

  <div id="tab-schedule-content">
    <h1 class="text-3xl font-extrabold text-center mt-4">Schedule Conflict Checker</h1>
    <p class="mt-2 text-center text-gray-600 mb-8">Paste, validate, and generate HRIS upload files for Work and Rest Day schedules.</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 px-8 py-6">
      <!-- Work -->
      <div>
        <div class="flex items-center justify-between mb-4 gap-4">
          <h3 class="font-semibold text-lg">1. Paste Work Schedule Data</h3>
          <div class="flex items-center gap-3">
            <input id="workBranchName" type="text" placeholder="Branch Name" class="border rounded px-3 py-2" />
            <button id="generateWorkFile" class="bg-indigo-600 text-white px-4 py-2 rounded">Generate</button>
            <button id="clearWorkData" class="bg-gray-100 px-4 py-2 rounded">Clear</button>
          </div>
        </div>
        <textarea id="workScheduleInput" class="w-full h-64 border rounded p-3 mb-4" placeholder="Paste work schedule (Excel copy) here"></textarea>
        <div class="overflow-auto bg-white rounded border">
          <table class="w-full text-sm text-center">
            <thead class="bg-gray-50 text-gray-600 text-xs">
              <tr><th>Name</th><th>Emp No.</th><th>Work Date</th><th>Shift</th><th>Day</th><th>Position</th></tr>
            </thead>
            <tbody id="workTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Rest -->
      <div>
        <div class="flex items-center justify-between mb-4 gap-4">
          <h3 class="font-semibold text-lg">2. Paste Rest Day Schedule Data</h3>
          <div class="flex items-center gap-3">
            <input id="restBranchName" type="text" placeholder="Branch Name" class="border rounded px-3 py-2" />
            <button id="generateRestFile" class="bg-indigo-600 text-white px-4 py-2 rounded">Generate</button>
            <button id="clearRestData" class="bg-gray-100 px-4 py-2 rounded">Clear</button>
          </div>
        </div>
        <textarea id="restScheduleInput" class="w-full h-64 border rounded p-3 mb-4" placeholder="Paste rest day schedule (Excel copy) here"></textarea>
        <div class="overflow-auto bg-white rounded border">
          <table class="w-full text-sm text-center">
            <thead class="bg-gray-50 text-gray-600 text-xs">
              <tr><th>Conflict</th><th>Name</th><th>Emp No.</th><th>Rest Date</th><th>Day</th><th>Position</th></tr>
            </thead>
            <tbody id="restTableBody"></tbody>
          </table>
        </div>
        <div id="summary" class="summary-box text-center hidden"></div>
      </div>
    </div>
  </div>

<!-- MONITORING -->
<div id="tab-monitoring-content" class="hidden dashboard-card mt-6 shadow-lg">
  <h2 class="text-2xl text-center mb-4">üìä Branch Monitoring Dashboard</h2>

  <div class="flex justify-center gap-3 mb-4">
    <select id="monthSelect" class="border rounded px-3 py-2">
      <option value="01">January</option>
      <option value="02">February</option>
      <option value="10" selected>October</option>
    </select>
    <select id="yearSelect" class="border rounded px-3 py-2">
      <option value="2025" selected>2025</option>
      <option value="2026">2026</option>
    </select>
    <button id="clearMonitoringBtn" class="bg-red-500 text-white px-4 py-2 rounded">Clear</button>
    <button id="exportMonitoringBtn" class="bg-green-600 text-white px-4 py-2 rounded">Export</button>
  </div>

  <div class="overflow-auto bg-white rounded border">
    <table class="w-full text-sm text-center">
      <thead class="bg-gray-100">
        <tr>
          <th>Branch</th>
          <th>Check</th>
          <th>Upload</th>
          <th>Uploaded By</th>
          <th>Remarks</th>
          <th>Progress</th>
        </tr>
      </thead>
      <tbody id="monitoringBody"></tbody>
    </table>
  </div>

  <p class="mt-4 text-center">
    Total: <span id="totalBranches">0</span> |
    Checked: <span id="checkedBranches">0</span> |
    Uploaded: <span id="uploadedBranches">0</span> |
    <span id="progressPercent">0%</span>
  </p>

  <div class="w-1/2 mx-auto bg-gray-200 rounded-full h-3 mt-2">
    <div id="progressBar" class="h-3 bg-green-500 rounded-full w-0"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /***** State *****/
  let workScheduleData = [];
  let restDayData = [];
  const LEADERSHIP_POSITIONS = ['Branch Head','Site Supervisor','OIC'];

  /***** Element refs *****/
  const workInput = document.getElementById('workScheduleInput');
  const restInput = document.getElementById('restScheduleInput');
  const workTableBody = document.getElementById('workTableBody');
  const restTableBody = document.getElementById('restTableBody');
  const summaryEl = document.getElementById('summary');
  const warningBanner = document.getElementById('warning-banner');
  const successMsg = document.getElementById('success-message');

  const generateWorkFileBtn = document.getElementById('generateWorkFile');
  const generateRestFileBtn = document.getElementById('generateRestFile');
  const clearWorkBtn = document.getElementById('clearWorkData');
  const clearRestBtn = document.getElementById('clearRestData');

  const tabSchedule = document.getElementById('tab-schedule');
  const tabMonitoring = document.getElementById('tab-monitoring');
  const scheduleContent = document.getElementById('tab-schedule-content');
  const monitoringContent = document.getElementById('tab-monitoring-content');

  // Monitoring refs
  const monitoringBody = document.getElementById('monitoringBody');
  const clearMonitoringBtn = document.getElementById('clearMonitoringBtn');
  const exportMonitoringBtn = document.getElementById('exportMonitoringBtn');
  const monthSelect = document.getElementById('monthSelect');
  const yearSelect = document.getElementById('yearSelect');
  const totalBranchesEl = document.getElementById('totalBranches');
  const checkedBranchesEl = document.getElementById('checkedBranches');
  const uploadedBranchesEl = document.getElementById('uploadedBranches');
  const progressPercentEl = document.getElementById('progressPercent');
  const progressBar = document.getElementById('progressBar');

  /***** Helpers *****/
  function showBanner(msg) {
    warningBanner.textContent = msg;
    warningBanner.classList.remove('hidden');
    warningBanner.classList.add('opacity-100');
    setTimeout(() => {
      warningBanner.classList.remove('opacity-100');
      setTimeout(() => warningBanner.classList.add('hidden'), 400);
    }, 3000);
  }

  function showSuccess() {
    successMsg.classList.remove('hidden');
    successMsg.style.animation = 'fadeInOut 2.5s ease-in-out';
    setTimeout(() => {
      successMsg.classList.add('hidden');
      successMsg.style.animation = '';
    }, 2500);
  }

  function parseTabular(text) {
    if (!text) return [];
    const lines = text.replace(/\r/g, '').split('\n').map(l => l.trim()).filter(Boolean);
    return lines.map(line => line.split(/\t|,|\s{2,}/).map(c => c.trim()));
  }

function detectHeaderAndMap(rows) {
  if (!rows || rows.length === 0) return { dataRows: [], colMap: {} };
  
  const headerRow = rows[0];
  const headerLower = headerRow.map(c => (c || '').toString().toLowerCase().trim());

  const headerMap = {
    name: /name|employee\s*name|full\s*name/,
    empNo: /emp.*no|employee.*no|employee|emp\s*no|employee\s*number/,
    date: /date|work.*date|rest.*date/,
    shift: /shift|shift\s*code|work\s*shift/,
    day: /day|day\s*of\s*week/,
    position: /position|pos|job\s*title/
  };

  const colMap = {};

  // Detect columns based on header regex
  headerLower.forEach((header, index) => {
    for (const key in headerMap) {
      if (headerMap[key].test(header)) {
        colMap[key] = index;
        break;
      }
    }
  });

  // Set default column indices if some headers are missing
  if (colMap.empNo === undefined) colMap.empNo = 1;
  if (colMap.name === undefined) colMap.name = 0;
  if (colMap.date === undefined) colMap.date = 2;
  if (colMap.shift === undefined) colMap.shift = 3;
  if (colMap.day === undefined) colMap.day = 4;
  if (colMap.position === undefined) colMap.position = 5;

  const dataRows = rows.slice(1); // skip header row
  return { dataRows, colMap };
}

  /***** Rendering *****/
  function renderWorkTable() {
    workTableBody.innerHTML = workScheduleData.map(d => `
      <tr>
        <td>${escapeHtml(d.name)}</td>
        <td>${escapeHtml(d.empNo)}</td>
        <td>${escapeHtml(d.date)}</td>
        <td>${escapeHtml(d.shift)}</td>
        <td>${escapeHtml(d.day)}</td>
        <td>${escapeHtml(d.position)}</td>
      </tr>
    `).join('');
    if (workTableBody.parentElement) workTableBody.parentElement.scrollIntoView({ behavior: 'smooth' });
  }

  function escapeHtml(str) {
    return (str == null) ? '' : String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  function renderRestTable() {
    restTableBody.innerHTML = restDayData.map(d => {
      const isWeekend = /saturday|sunday/i.test((d.day || '').toLowerCase().trim());
      const conflictHtml = (d.conflicts || []).map(c => `<div><strong>${escapeHtml(c.type)}:</strong> ${escapeHtml(c.reason)}</div>`).join('');
      const rowClass = (d.conflicts && d.conflicts.length > 0)
        ? 'bg-yellow-50 border-l-4 border-yellow-400 conflict-row shadow-sm ring-2 ring-yellow-300/30'
        : '';
      return `
        <tr class="${rowClass}">
          <td class="text-left p-2 max-w-xs">${conflictHtml || ''}</td>
          <td>${escapeHtml(d.name)}</td>
          <td>${escapeHtml(d.empNo)}</td>
          <td class="${isWeekend? 'weekend-rest-day':''}">${escapeHtml(d.date)}</td>
          <td class="${isWeekend? 'weekend-rest-day':''}">${escapeHtml(d.day)}</td>
          <td>${escapeHtml(d.position)}</td>
        </tr>
      `;
    }).join('');

    // Update buttons after table renders
    updateButtonStates();

    // Update summary box
    const total = restDayData.length;
    const conflicts = restDayData.filter(r => r.conflicts && r.conflicts.length > 0).length;

    if (total === 0) {
      summaryEl.textContent = '';
      summaryEl.classList.add('hidden');
    } else {
      summaryEl.classList.remove('hidden');
      if (conflicts === 0) {
        summaryEl.textContent = `‚úÖ No conflicts detected for ${total} entries.`;
        summaryEl.classList.remove('text-red-600');
        summaryEl.classList.add('text-green-600');
      } else {
        summaryEl.textContent = `${conflicts} out of ${total} entries have conflicts detected.`;
        summaryEl.classList.remove('text-green-600');
        summaryEl.classList.add('text-red-600');
      }
    }
  }

  /***** Validation *****/
  function validateSchedules() {
    // reset conflicts
    restDayData.forEach(r => r.conflicts = []);

    // build maps
    const workMap = new Map(workScheduleData.map(w => [`${w.empNo}-${(w.date || '').trim()}`, w]));
    const workEmpSet = new Set(workScheduleData.map(w => w.empNo));
    const restByDate = {};
    const weekendCount = {};
    const seen = new Set();

    restDayData.forEach(rd => {
      if (!rd) return;
      const key = `${rd.empNo}-${(rd.date || '').trim()}`;
      if (!restByDate[rd.date]) restByDate[rd.date] = [];
      restByDate[rd.date].push(rd);

      // duplicate
      if (seen.has(key)) rd.conflicts.push({ type: 'Duplicate Entry', reason: 'Duplicate rest day entry for same employee & date.' });
      else seen.add(key);

      // missing employee
      if (!workEmpSet.has(rd.empNo))
        rd.conflicts.push({ type: 'Missing Employee', reason: 'Employee not found in Work Schedule data.' });

      // invalid date
      const d = new Date(rd.date);
      if (isNaN(d.getTime()))
        rd.conflicts.push({ type: 'Invalid Date Format', reason: 'Date format unrecognized.' });

      // work conflict
      if (workMap.has(key))
        rd.conflicts.push({ type: 'Work Conflict', reason: 'Employee has a work schedule on same date.' });

      // weekend count
      if (/saturday|sunday/i.test(rd.day || '')) {
        if (!isNaN(d.getTime())) {
          const monthYear = `${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
          const wkKey = `${rd.empNo}-${monthYear}`;
          weekendCount[wkKey] = (weekendCount[wkKey] || 0) + 1;
        }
      }
    });

    // leadership conflict
    for (const date in restByDate) {
      const leaders = restByDate[date].filter(r => LEADERSHIP_POSITIONS.includes(r.position));
      if (leaders.length > 1)
        leaders.forEach(l => l.conflicts.push({ type: 'Leadership Conflict', reason: 'Multiple leaders have same rest day.' }));
    }

    // weekend limit
    for (const wkey in weekendCount) {
      if (weekendCount[wkey] > 2) {
        const [emp] = wkey.split('-');
        restDayData.filter(r => r.empNo === emp && /saturday|sunday/i.test(r.day || '')).forEach(r => {
          r.conflicts.push({ type: 'Weekend Limit Exceeded', reason: `${weekendCount[wkey]} weekend rest days ‚Äî maximum 2.` });
        });
      }
    }

    renderRestTable();
    updateButtonStates();
  }

  function updateButtonStates() {
    generateWorkFileBtn.disabled = workScheduleData.length === 0;
    const hasConf = restDayData.some(r => r.conflicts && r.conflicts.length > 0);
    generateRestFileBtn.disabled = restDayData.length === 0 || hasConf;
  }

  /***** Paste handler (shared) *****/
function handlePaste(e, type) {
  e.preventDefault();
  const clipboardData = e.clipboardData || window.clipboardData;
  const pastedData = clipboardData.getData('text/plain').trim();

  if (!pastedData) return;

  // Parse pasted text into rows/columns
  const parsed = parseTabular(pastedData);
  const { dataRows, colMap } = detectHeaderAndMap(parsed);

  const cleaned = dataRows.map(row => ({
    name: row[colMap.name] || '',
    empNo: row[colMap.empNo] || '',
    date: normalizeDate(row[colMap.date]),
    shift: row[colMap.shift] || '',
    day: row[colMap.day] || '',
    position: row[colMap.position] || ''
  })).filter(r => r.empNo && r.date);

  if (type === 'work') {
    workScheduleData = cleaned;
    renderWorkTable();
    workInput.value = ''; // clear textarea visually
    showBanner(`‚úÖ ${cleaned.length} work schedule rows pasted.`);
  } else {
    restDayData = cleaned;
    validateSchedules();
    renderRestTable();
    restInput.value = ''; // clear textarea visually
    showBanner(`‚úÖ ${cleaned.length} rest day rows pasted.`);
  }

  updateButtonStates();
}

// Attach paste listeners
workInput.addEventListener('paste', (e) => handlePaste(e, 'work'));
restInput.addEventListener('paste', (e) => handlePaste(e, 'rest'));

// --- Helper to fix inconsistent date formats ---
function normalizeDate(dateStr) {
  if (!dateStr) return '';

  // If it's already like 10/01/25 or 10-01-25
  const match = dateStr.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
  if (match) {
    let [_, mm, dd, yy] = match;
    mm = mm.padStart(2, '0');
    dd = dd.padStart(2, '0');
    if (yy.length === 4) yy = yy.slice(2); // make 2025 ‚Üí 25
    return `${mm}/${dd}/${yy}`;
  }

  // If Excel serial number (e.g., 45812)
  if (!isNaN(dateStr) && Number(dateStr) > 10000) {
    const excelEpoch = new Date(1899, 11, 30);
    const parsed = new Date(excelEpoch.getTime() + (Number(dateStr) * 86400000));
    const mm = String(parsed.getMonth() + 1).padStart(2, '0');
    const dd = String(parsed.getDate()).padStart(2, '0');
    const yy = String(parsed.getFullYear()).slice(2);
    return `${mm}/${dd}/${yy}`;
  }

  // Fallback: try Date parse
  const parsed = new Date(dateStr);
  if (!isNaN(parsed)) {
    const mm = String(parsed.getMonth() + 1).padStart(2, '0');
    const dd = String(parsed.getDate()).padStart(2, '0');
    const yy = String(parsed.getFullYear()).slice(2);
    return `${mm}/${dd}/${yy}`;
  }

  return dateStr; // return original if nothing matched
}


  /***** Button handlers for generate/clear *****/
  function generateHrisFile(type) {
    const workBranch = document.getElementById('workBranchName').value.trim();
    const restBranch = document.getElementById('restBranchName').value.trim();

    if (type === 'work') {
      if (!workBranch) return showBanner('‚ö†Ô∏è Enter Work Branch Name.');
      if (workScheduleData.length === 0) return showBanner('‚ö†Ô∏è No Work Schedule data to generate.');
      const data = [
  ['Employee Number', 'Work Date', 'Shift Code'], // single header
  ...workScheduleData.map(r => [r.empNo, r.date, r.shift])
];

// Ensure no duplicate headers like EMPLOYEE NO. etc.
const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'HRIS Upload');
      XLSX.writeFile(wb, `${workBranch}_WORK_SCHEDULE.xlsx`);
      showSuccess();
    } else {
      if (!restBranch) return showBanner('‚ö†Ô∏è Enter Rest Branch Name.');
      if (restDayData.length === 0) return showBanner('‚ö†Ô∏è No Rest Day data to generate.');
      // check for conflicts
      if (restDayData.some(r => r.conflicts && r.conflicts.length > 0))
        return showBanner('‚ö†Ô∏è Resolve conflicts before generating Rest Day file.');
      const data = restDayData.map(r => ({ 'Employee No': r.empNo, 'Rest Day Date': r.date }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'HRIS Upload');
      XLSX.writeFile(wb, `${restBranch}_REST_DAY_UPLOAD.xlsx`);
      showSuccess();
    }
  }

  generateWorkFileBtn.addEventListener('click', () => generateHrisFile('work'));
  generateRestFileBtn.addEventListener('click', () => generateHrisFile('rest'));

  clearWorkBtn.addEventListener('click', () => {
    workScheduleData = []; workInput.value = ''; renderWorkTable(); updateButtonStates(); showBanner('Work schedule cleared.');
  });
 clearRestBtn.addEventListener('click', () => {
  restDayData = [];
  restInput.value = '';
  renderRestTable();
  updateButtonStates();
  showBanner('Rest day schedule cleared.');
});

  /***** Monitoring logic *****/
  const defaultMonitoring = [
    { name: 'AASP ABREEZA', checked: false, uploaded: false, uploadedBy: '', remarks: '' },
    { name: 'AASP NES - ATLAS', checked: false, uploaded: false, uploadedBy: '', remarks: '' }
  ];

  function getMonitoring() {
    const data = localStorage.getItem('monitoringData');
    if (data) {
      try {
        return JSON.parse(data);
      } catch (e) {
        return [...defaultMonitoring];
      }
    }
    return [...defaultMonitoring];
  }
  function saveMonitoring(d) {
    localStorage.setItem('monitoringData', JSON.stringify(d));
  }

  function renderMonitoring() {
    const data = getMonitoring();
    monitoringBody.innerHTML = data.map((b, i) => `
      <tr>
        <td class="text-left p-2">${escapeHtml(b.name)}</td>
        <td><input type="checkbox" data-index="${i}" data-field="checked" ${b.checked ? 'checked' : ''}></td>
        <td><input type="checkbox" data-index="${i}" data-field="uploaded" ${b.uploaded ? 'checked' : ''}></td>
        <td><input type="text" data-index="${i}" data-field="uploadedBy" value="${escapeHtml(b.uploadedBy)}" class="px-1 py-0.5"></td>
        <td><input type="text" data-index="${i}" data-field="remarks" value="${escapeHtml(b.remarks)}" class="px-1 py-0.5"></td>
        <td>${b.uploaded ? '‚úÖ Done' : b.checked ? 'üü° Checked' : '‚ùå Pending'}</td>
      </tr>
    `).join('');

    // attach listeners
    monitoringBody.querySelectorAll('input').forEach(inp => {
      inp.addEventListener('change', (e) => {
        const idx = Number(e.target.dataset.index);
        const field = e.target.dataset.field;
        const d = getMonitoring();
        if (e.target.type === 'checkbox') d[idx][field] = e.target.checked;
        else d[idx][field] = e.target.value;
        saveMonitoring(d);
        updateMonitoringStats(); // only update stats
      });
    });
    // Also handle text input change
    monitoringBody.querySelectorAll('input[type=text]').forEach(inp => {
      inp.addEventListener('input', (e) => {
        const idx = Number(e.target.dataset.index);
        const field = e.target.dataset.field;
        const d = getMonitoring();
        d[idx][field] = e.target.value;
        saveMonitoring(d);
        // no need to update stats here
      });
    });

    updateMonitoringStats();
  }

  function updateMonitoringStats() {
    const d = getMonitoring();
    const total = d.length;
    const checked = d.filter(x => x.checked).length;
    const uploaded = d.filter(x => x.uploaded).length;
    totalBranchesEl && (totalBranchesEl.textContent = total);
    checkedBranchesEl && (checkedBranchesEl.textContent = checked);
    uploadedBranchesEl && (uploadedBranchesEl.textContent = uploaded);
    const pct = total ? Math.round((uploaded / total) * 100) : 0;
    progressPercentEl && (progressPercentEl.textContent = pct + '%');
    progressBar.style.width = pct + '%';
  }

  clearMonitoringBtn.addEventListener('click', () => {
    if (confirm('Clear monitoring data?')) {
      localStorage.removeItem('monitoringData');
      renderMonitoring();
    }
  });
  exportMonitoringBtn.addEventListener('click', () => {
    const data = getMonitoring();
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Monitoring');
    const monthText = monthSelect.options[monthSelect.selectedIndex].text;
    XLSX.writeFile(wb, `Monitoring_${monthText}_${yearSelect.value}.xlsx`);
  });

  // tabs
  tabSchedule.addEventListener('click', () => {
    scheduleContent.classList.remove('hidden');
    monitoringContent.classList.add('hidden');
    tabSchedule.classList.add('bg-indigo-600', 'text-white');
    tabMonitoring.classList.remove('bg-indigo-600', 'text-white');
  });
  tabMonitoring.addEventListener('click', () => {
    scheduleContent.classList.add('hidden');
    monitoringContent.classList.remove('hidden');
    tabMonitoring.classList.add('bg-indigo-600', 'text-white');
    tabSchedule.classList.remove('bg-indigo-600', 'text-white');
    renderMonitoring(); // render once per click
  });

  // initial UI state
  renderWorkTable();
  renderRestTable();
  updateButtonStates();
  renderMonitoring();
});
</script>
<!-- ================================
 üåå Tech Breeze Animation Layer
 Powered by GSAP + Vanilla JS Particles
================================ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

<!-- Particle container -->
<div id="particle-container"></div>

<script>
// ========== üåü Floating Particles ==========
const container = document.getElementById("particle-container");
const numParticles = 40;
const colors = ["#0ea5e9", "#14b8a6", "#67e8f9", "#99f6e4"];

for (let i = 0; i < numParticles; i++) {
  const dot = document.createElement("div");
  dot.classList.add("particle");
  gsap.set(dot, {
    position: "absolute",
    width: gsap.utils.random(2, 5),
    height: gsap.utils.random(2, 5),
    borderRadius: "50%",
    background: gsap.utils.random(colors),
    x: gsap.utils.random(window.innerWidth),
    y: gsap.utils.random(window.innerHeight),
    opacity: gsap.utils.random(0.3, 0.9)
  });
  container.appendChild(dot);

  // floating motion loop
  gsap.to(dot, {
    duration: gsap.utils.random(12, 24),
    x: `+=${gsap.utils.random(-100, 100)}`,
    y: `+=${gsap.utils.random(-80, 80)}`,
    repeat: -1,
    yoyo: true,
    ease: "sine.inOut"
  });
}

// ========== üé≠ Header + Card Entrance ==========
gsap.utils.toArray("header, .dashboard-card").forEach((el, i) => {
  gsap.fromTo(el, 
    { opacity: 0, y: 30 },
    { opacity: 1, y: 0, delay: 0.2 + i * 0.1, duration: 0.8, ease: "power3.out" }
  );
});

// ========== üéÆ Parallax Header Drift ==========
const header = document.querySelector("header");
if (header) {
  document.addEventListener("mousemove", (e) => {
    const x = (e.clientX / window.innerWidth - 0.5) * 30;
    const y = (e.clientY / window.innerHeight - 0.5) * 30;
    gsap.to(header, { duration: 1.5, backgroundPosition: `${50 + x}% ${50 + y}%`, ease: "power2.out" });
  });
}

// ========== üßä Particle Layer CSS ==========
const style = document.createElement("style");
style.innerHTML = `
  #particle-container .particle {
    position: absolute;
    will-change: transform, opacity;
    z-index: 0;
    mix-blend-mode: screen;
  }
`;
document.head.appendChild(style);
</script>

</body>
</html>
