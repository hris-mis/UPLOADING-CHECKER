<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Schedule Conflict Checker</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
<!-- Library for Excel file generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  /* Your existing styles ... (unchanged) */
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
  }
  table {
    table-layout: auto;
    width: 100%;
    border-collapse: collapse;
  }
  th {
    background: linear-gradient(to right, #f9fafb, #f3f4f6);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    font-size: 0.85rem;
  }
  .paste-area {
    border: 2px dashed #d1d5db;
    padding: 1rem;
    background-color: #ffffff;
    border-radius: 0.75rem;
    min-height: 300px;
    width: 100%;
    white-space: pre;
    overflow-x: auto;
    overflow-y: auto;
    color: #374151;
    cursor: text;
    font-size: 0.9rem;
    letter-spacing: 0.01em;
    border: 1px solid #d1d5db;
    border-left: 4px solid #4f46e5;
  }
  .paste-area:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
  }
  .table-container {
    overflow-x: auto;
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    border-radius: 0.75rem;
    background-color: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    transition: all 0.2s ease-in-out;
  }
  table {
    width: 100%;
    table-layout: auto;
  }
  th:nth-child(1), td:nth-child(1) { width: 14%; }
  th:nth-child(2), td:nth-child(2) { width: 10%; }
  th:nth-child(3), td:nth-child(3) { width: 12%; }
  th:nth-child(4), td:nth-child(4) { width: 11%; }
  th:nth-child(5), td:nth-child(5) { width: 11%; }
  th:nth-child(6), td:nth-child(6) { width: 14%; }
  th, td {
    padding: 0.85rem 1.25rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
    white-space: nowrap;
    font-size: 0.9rem;
  }
  th {
    background-color: #f9fafb;
    font-weight: 600;
    color: #374151;
  }
  .conflict {
    background-color: #fff7ed;
    color: #b45309;
    font-weight: 500;
    border-left: 4px solid #f59e0b;
    white-space: pre-wrap;
    word-break: break-word;
    padding: 0.75rem;
    min-width: 320px;
    max-width: 480px;
    border-radius: 0.5rem;
  }
  .weekend-rest-day {
    color: #dc2626;
    font-weight: 500;
  }
  th:first-child, td:first-child {
    position: sticky;
    left: 0;
    background-color: #fffbea; /* light yellow */
    z-index: 2;
    box-shadow: 2px 0 5px rgba(0,0,0,0.05);
  }
  html, body {
    overflow-x: hidden;
  }
  tbody tr {
    transition: background 0.3s ease, transform 0.2s ease;
  }
  tbody tr:hover {
    background: #f9fafb;
    transform: scale(1.01);
  }
  #monitoringTable th {
    background: #f8fafc;
    color: #1e3a8a;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.03em;
  }
  #monitoringTable td {
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
  }
  #monitoringBody tr:hover {
    background-color: #f1f5f9;
  }
  /* Align both input+button headers perfectly */
  .flex.items-center input[type="text"] {
    min-width: 180px;
  }
  button#generate-work-btn, button#generate-rest-btn {
    min-width: 130px;
  }
  #monitoringBody td input, #monitoringBody td select {
    text-align: center;
  }
</style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

<div id="warning-banner" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg shadow-md transition-opacity opacity-0"></div>

<div class="max-w-[1600px] mx-auto">

<header class="mb-10 text-center">
<div class="flex justify-center space-x-4 mb-8">
<button id="tab-schedule" class="px-6 py-2 rounded-full font-semibold bg-indigo-600 text-white shadow-md hover:bg-indigo-700 transition">üóìÔ∏è Schedule Checker</button>
<button id="tab-monitoring" class="px-6 py-2 rounded-full font-semibold bg-gray-200 text-gray-700 hover:bg-indigo-100 transition">üìä Monitoring</button>
</div>
</header>

<!-- Success Message -->
<div id="success-message" class="hidden fixed top-6 right-6 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 px-6 rounded-lg shadow-lg font-medium transition-transform transform translate-x-full">
‚úÖ Validation successful! HRIS upload file has been generated.
</div>

<!-- Container for side-by-side layout -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full">

<!-- Schedule Checker Content -->
<div id="tab-schedule-content">
  <h1 class="text-4xl font-extrabold bg-gradient-to-r from-indigo-700 to-blue-500 text-transparent bg-clip-text text-center mt-4">
    Schedule Conflict Checker
  </h1>
  <p class="mt-2 text-gray-600 text-sm tracking-wide text-center mb-6">
    Validate, review, and export work & rest day schedules with ease.
  </p>

  <!-- üü¶ MIRRORED SIDE-BY-SIDE PANELS -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 px-4 md:px-8 lg:px-12 xl:px-16">

    <!-- LEFT: Work Schedule -->
    <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col border border-gray-100 hover:shadow-xl transition">
      <div class="flex flex-wrap md:flex-nowrap items-center mb-4 gap-3">
        <h3 class="font-semibold text-lg text-indigo-700 whitespace-nowrap flex-shrink-0">
          1. Paste Work Schedule Data
        </h3>
        <input id="workBranchName" type="text" placeholder="Enter Branch Name"
               class="border border-gray-300 rounded-lg px-3 py-2 text-sm flex-1 focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
        <div class="flex gap-2 mt-2 md:mt-0">
          <button id="generateWorkFile"
                  class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm shadow">
            Generate File
          </button>
          <button id="clearWorkData"
                  class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow">
            Clear
          </button>
        </div>
      </div>

      <textarea id="workScheduleInput"
                class="w-full h-64 border border-indigo-400 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-4"></textarea>

      <div class="overflow-x-auto">
        <table id="workScheduleTable" class="w-full text-sm text-center border-collapse">
          <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
            <tr>
              <th class="px-2 py-2 border">Name</th>
              <th class="px-2 py-2 border">Emp No.</th>
              <th class="px-2 py-2 border">Work Date</th>
              <th class="px-2 py-2 border">Shift</th>
              <th class="px-2 py-2 border">Day</th>
              <th class="px-2 py-2 border">Position</th>
            </tr>
          </thead>
          <tbody id="workTableBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT: Rest Day Schedule -->
    <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col border border-gray-100 hover:shadow-xl transition">
      <div class="flex flex-wrap md:flex-nowrap items-center mb-4 gap-3">
        <h3 class="font-semibold text-lg text-indigo-700 whitespace-nowrap flex-shrink-0">
          2. Paste Rest Day Schedule Data
        </h3>
        <input id="restBranchName" type="text" placeholder="Enter Branch Name"
               class="border border-gray-300 rounded-lg px-3 py-2 text-sm flex-1 focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
        <div class="flex gap-2 mt-2 md:mt-0">
          <button id="generateRestFile"
                  class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm shadow">
            Generate File
          </button>
          <button id="clearRestData"
                  class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow">
            Clear
          </button>
        </div>
      </div>

      <textarea id="restScheduleInput"
                class="w-full h-64 border border-indigo-400 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-4"></textarea>

      <div class="overflow-x-auto">
        <table id="restScheduleTable" class="w-full text-sm text-center border-collapse">
          <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
            <tr>
              <th class="px-2 py-2 border">Conflict</th>
              <th class="px-2 py-2 border">Name</th>
              <th class="px-2 py-2 border">Emp No.</th>
              <th class="px-2 py-2 border">Rest Date</th>
              <th class="px-2 py-2 border">Day</th>
              <th class="px-2 py-2 border">Position</th>
            </tr>
          </thead>
          <tbody id="restTableBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- üßπ Clear All Button -->
  <div class="text-center mt-8">
    <button id="clearAllBtn"
            class="bg-gradient-to-r from-red-600 to-rose-600 text-white px-6 py-3 rounded-xl font-medium hover:from-red-700 hover:to-rose-700 shadow-md transition">
      üßπ Clear All (Work + Rest Day)
    </button>
  </div>
</div>




<!-- ‚úÖ MONITORING TAB -->
<div id="tab-monitoring-content" class="hidden p-6">
  <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">üìä Branch Monitoring Dashboard</h2>
  <div class="flex justify-center mb-6 mt-4">
  <button id="clearMonitoringBtn"
    class="bg-red-500 hover:bg-red-600 text-white font-semibold px-6 py-2 rounded-lg shadow">
    üßπ Clear All Data
  </button>
</div>

<!-- Monitoring branch progress area -->

<select id="monthSelect" class="border rounded-lg px-3 py-2 text-sm">
  <option value="01">January</option>
  <option value="02">February</option>
  <option value="03">March</option>
  <option value="04">April</option>
  <option value="05">May</option>
  <option value="06">June</option>
  <option value="07">July</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10" selected>October</option>
  <option value="11">November</option>
  <option value="12">December</option>
</select>

<select id="yearSelect" class="border rounded-lg px-3 py-2 text-sm">
  <option value="2025" selected>2025</option>
  <option value="2026">2026</option>
</select>


  <!-- Progress summary -->
  <div class="text-center text-gray-700 mb-4">
    <p>Total Branches: <span id="totalBranches">0</span> |
       Checked: <span id="checkedBranches">0</span> |
       Uploaded: <span id="uploadedBranches">0</span> |
       Progress: <span id="progressPercent">0%</span></p>
    <div class="w-1/2 mx-auto bg-gray-200 rounded-full h-3 mt-2">
      <div id="progressBar" class="h-3 bg-green-500 rounded-full w-0"></div>
    </div>
  </div>

<!-- üîπ Branch Controls -->
<div class="flex flex-wrap justify-center gap-3 mb-4">
  <input id="newBranchName" type="text" placeholder="Enter new branch name"
    class="border border-gray-300 rounded-md px-3 py-2 w-60 focus:ring-2 focus:ring-indigo-500">
  <button id="addBranchBtn"
    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg">‚ûï Add Branch</button>
  <button id="editBranchBtn"
    class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-4 py-2 rounded-lg">‚úèÔ∏è Edit Branches</button>
</div>

<!-- üîç Search -->
<div class="flex justify-center mb-4">
  <input id="monitoringSearch" type="text" placeholder="Search branch..."
    class="border border-gray-300 rounded-md px-3 py-2 w-64 focus:ring-2 focus:ring-indigo-500">
</div>


  <!-- Branch Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-300 rounded-lg text-sm text-center align-middle table-auto">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-2 text-left">Branch</th>
          <th class="p-2 text-center">Check</th>
          <th class="p-2 text-center">Upload</th>
          <th class="p-2 text-center">Uploaded By</th>
          <th class="p-2 text-center">Remarks</th>
          <th class="p-2 text-center">Progress</th>
        </tr>
      </thead>
      <tbody id="monitoringBody"></tbody>
    </table>
  </div>

  <!-- Export -->
  <div class="flex justify-center mt-6">
    <button id="exportMonitoringBtn"
      class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-2 rounded-lg shadow">
      üì§ Export Monitoring (Excel)
    </button>
  </div>
</div>

  <script>
    // Data stores
    let workScheduleData = [];
    let restDayData = [];

    const LEADERSHIP_POSITIONS = ['Branch Head', 'Site Supervisor', 'OIC'];

    // --- PASTE AND PARSE LOGIC ---
function handlePaste(e, type) {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text/plain');

    e.target.innerText = '';

    const allRows = text.trim().split('\n').map(row => row.split('\t'));

    // ‚úÖ Check if first row is a merged header like "WORK SCHEDULE" or "REST DAY SCHEDULE"
    const hasMergedHeader = allRows[0].length === 1 && 
        (allRows[0][0].toLowerCase().includes('work schedule') || allRows[0][0].toLowerCase().includes('rest day schedule'));

    // ‚úÖ Skip 1 or 2 rows if necessary (title row + column headers)
    const rows = hasMergedHeader ? allRows.slice(2) : allRows.slice(1); 

if (type === 'work') {
    workScheduleData = rows.map(row => {
        let name = '', empNo = '';

        // üîç Detect column order automatically
        if (/^\d+$/.test(row[0]?.trim())) {
            empNo = row[0];
            name = row[1];
        } else {
            name = row[0];
            empNo = row[1];
        }

        return {
            name: name || '',
            empNo: empNo || '',
            date: row[2] ? normalizeDate(row[2]) : '',
            shift: row[3] || '',
            day: row[4] || '',
            position: row[5] || ''
        };
    }).filter(d => d.empNo && d.date);
    renderWorkTable();

} else if (type === 'rest') {
    restDayData = rows.map(row => {
        let name = '', empNo = '';

        // üîç Detect column order automatically
        if (/^\d+$/.test(row[0]?.trim())) {
            empNo = row[0];
            name = row[1];
        } else {
            name = row[0];
            empNo = row[1];
        }

        return {
            empNo: empNo || '',
            name: name || '',
            date: row[2] ? normalizeDate(row[2]) : '',
            day: row[3] || '',
            position: row[4] || '',
            conflicts: []
        };
    }).filter(d => d.empNo && d.date);
}
    validateSchedules();
    
    function normalizeDate(dateString) {
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}/${day}/${year}`;
        } catch(e) {
            return dateString;
        }
    }

    // --- RENDERING LOGIC ---
    function renderWorkTable() {
        const tbody = document.getElementById('work-schedule-body');
        tbody.innerHTML = workScheduleData.map(d => `
            <tr>
                <td>${d.name}</td>
                <td>${d.empNo}</td>
                <td>${d.date}</td>
                <td>${d.shift}</td>
                <td>${d.day}</td>
                <td>${d.position}</td>
            </tr>
        `).join('');
    }

function renderRestDayTable() {
    const tbody = document.getElementById('rest-day-body');
    tbody.innerHTML = restDayData.map(d => {
        const isWeekend = d.day === 'Saturday' || d.day === 'Sunday';
        const hasConflict = d.conflicts.length > 0;
        const rowHighlight = hasConflict ? 'bg-yellow-50 border-l-4 border-yellow-400' : '';
        const conflictMessages = d.conflicts.map(c => `<div><strong>${c.type}:</strong> ${c.reason}</div>`).join('');

        return `
            <tr class="${rowHighlight}">
                <td class="font-medium text-red-600 max-w-xs overflow-y-auto whitespace-pre-line">
                    ${conflictMessages || ''}
                </td>
                <td>${d.name}</td>
                <td>${d.empNo}</td>
                <td class="${isWeekend ? 'weekend-rest-day' : ''}">${d.date}</td>
                <td class="${isWeekend ? 'weekend-rest-day' : ''}">${d.day}</td>
                <td>${d.position}</td>
            </tr>
        `;
    }).join('');

    // ‚úÖ Move summary counter here (after rendering)
    const total = restDayData.length;
    const conflicts = restDayData.filter(d => d.conflicts && d.conflicts.length > 0).length;
    document.getElementById('summary').innerText =
      `${conflicts} out of ${total} entries have conflicts detected.`;

      if (conflicts === 0 && total > 0) {
  document.getElementById('summary').classList.add('text-green-600');
  document.getElementById('summary').innerText = `‚úÖ No conflicts detected for ${total} entries.`;
} else {
  document.getElementById('summary').classList.remove('text-green-600');
}

}
    
    // --- BUTTON AND STATE MANAGEMENT ---
    function updateButtonStates() {
        const workBtn = document.getElementById('generate-work-btn');
        const restBtn = document.getElementById('generate-rest-btn');

        workBtn.disabled = workScheduleData.length === 0;

        const hasConflicts = restDayData.some(d => d.conflicts.length > 0);
        restBtn.disabled = restDayData.length === 0 || hasConflicts;
    }

    // --- VALIDATION LOGIC ---
function validateSchedules() {
    if (workScheduleData.length > 0 || restDayData.length > 0) {
        restDayData.forEach(rd => rd.conflicts = []);

        const workScheduleMap = new Map(workScheduleData.map(ws => [`${ws.empNo}-${ws.date}`, ws]));
        const empNumbersInWork = new Set(workScheduleData.map(ws => ws.empNo));
        const restDaysByDate = {};
        const weekendRestDaysByEmployee = {};
        const seenRestEntries = new Set();

        restDayData.forEach(rd => {
            if (!restDaysByDate[rd.date]) restDaysByDate[rd.date] = [];
            restDaysByDate[rd.date].push(rd);

            // --- Weekend Count ---
            const isWeekend = rd.day === 'Saturday' || rd.day === 'Sunday';
            if (isWeekend) {
                const monthYear = rd.date.substring(0, 2) + '/' + rd.date.substring(6, 10);
                const key = `${rd.empNo}-${monthYear}`;
                if (!weekendRestDaysByEmployee[key]) weekendRestDaysByEmployee[key] = 0;
                weekendRestDaysByEmployee[key]++;
            }

            // --- Duplicate Entry Check ---
            const uniqueKey = `${rd.empNo}-${rd.date}`;
            if (seenRestEntries.has(uniqueKey)) {
                rd.conflicts.push({ type: 'Duplicate Entry', reason: 'Duplicate rest day entry found for same employee and date.' });
            } else {
                seenRestEntries.add(uniqueKey);
            }

            // --- Invalid Date Format ---
            const d = new Date(rd.date);
            if (isNaN(d.getTime())) {
                rd.conflicts.push({ type: 'Invalid Date Format', reason: 'Date format unrecognized or invalid.' });
            }

            // --- Missing Employee Check ---
            if (!empNumbersInWork.has(rd.empNo)) {
                rd.conflicts.push({ type: 'Missing Employee', reason: 'Employee found in Rest Day sheet but not in Work Schedule data.' });
            }

            // --- Work Conflict ---
            if (workScheduleMap.has(uniqueKey)) {
                rd.conflicts.push({ type: 'Work Conflict', reason: 'Employee has a work schedule on the same date as their rest day.' });
            }
        });

        // --- Leadership Conflict ---
        for (const date in restDaysByDate) {
            const leadersOnRest = restDaysByDate[date].filter(rd => LEADERSHIP_POSITIONS.includes(rd.position));
            if (leadersOnRest.length > 1) {
                leadersOnRest.forEach(rd => {
                    rd.conflicts.push({ type: 'Leadership Conflict', reason: 'Multiple leaders (Branch Head/Supervisor/OIC) have the same rest day.' });
                });
            }
        }
// --- Weekend Pair Validation (optional enhancement) ---
const weekendPairs = [
    ['Thursday', 'Friday'],
    ['Friday', 'Saturday'],
    ['Saturday', 'Sunday'],
    ['Sunday', 'Monday']
];

const groupedByEmp = {};
restDayData.forEach(rd => {
    if (!groupedByEmp[rd.empNo]) groupedByEmp[rd.empNo] = [];
    groupedByEmp[rd.empNo].push(rd);
});

Object.keys(groupedByEmp).forEach(empNo => {
    const empDays = groupedByEmp[empNo];
    const dayNames = empDays.map(d => d.day);
    let detectedPairs = new Set();

    weekendPairs.forEach(([a, b]) => {
        if (dayNames.includes(a) && dayNames.includes(b)) {
            detectedPairs.add(`${a}-${b}`);
        }
    });

    const hasFriday = dayNames.includes('Friday');
    const hasSaturday = dayNames.includes('Saturday');
    const hasWeekday = dayNames.some(d => !['Friday','Saturday','Sunday'].includes(d));
    if (hasFriday && hasWeekday) detectedPairs.add('Friday + Weekday');
    if (hasSaturday && hasWeekday) detectedPairs.add('Saturday + Weekday');

    if (detectedPairs.size > 2) {
        const reason = `Weekend Limit Exceeded: ${detectedPairs.size} weekend RDs (${[...detectedPairs].join(', ')})`;
        empDays.forEach(d => {
            d.conflicts.push({ type: 'Weekend Pair Violation', reason });
        });
    }
});

        // --- Weekend Limit Exceeded ---
        for (const key in weekendRestDaysByEmployee) {
            if (weekendRestDaysByEmployee[key] > 2) {
                const [empNo, monthYear] = key.split('-');
                restDayData.forEach(rd => {
                    const rdMonthYear = rd.date.substring(0, 2) + '/' + rd.date.substring(6, 10);
                    const isWeekend = rd.day === 'Saturday' || rd.day === 'Sunday';
                    if (rd.empNo === empNo && rdMonthYear === monthYear && isWeekend) {
                        rd.conflicts.push({
                            type: 'Weekend Limit Exceeded',
                            reason: `${weekendRestDaysByEmployee[key]} weekend rest days found ‚Äî maximum allowed is 2.`
                        });
                    }
                });
            }
        }
    }

    // ‚úÖ Scroll to first conflict if any
const firstConflict = restDayData.find(rd => rd.conflicts.length > 0);
if (firstConflict) {
  setTimeout(() => {
    const row = document.querySelector('td.font-medium.text-red-600');
    if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 200);
}

    renderRestDayTable();
    updateButtonStates();
}
}
// --- FILE GENERATION ---
function generateHrisFile(type) {
  const banner = document.getElementById('warning-banner');

  function showBanner(message) {
    banner.textContent = message;
    banner.classList.remove('hidden');
    banner.classList.add('opacity-100');
    setTimeout(() => {
      banner.classList.remove('opacity-100');
      setTimeout(() => banner.classList.add('hidden'), 500);
    }, 4000);
  }

  let branchName = '';
  let data = [];
  let filename = '';

  if (type === 'work') {
    branchName = document.getElementById('work-branch-name').value.trim();
    if (!branchName) {
      showBanner("‚ö†Ô∏è Please enter the Work Branch Name before generating the file.");
      return;
    }
    if (workScheduleData.length === 0) {
      showBanner("‚ö†Ô∏è No Work Schedule data found. Please paste it first.");
      return;
    }

    data = workScheduleData.map(item => ({
      'Employee Number': item.empNo,
      'Work Date': item.date,
      'Shift Code': item.shift || ''
    }));

    filename = `${branchName}_WORK_SCHEDULE.xlsx`;
  }

  else if (type === 'rest') {
    branchName = document.getElementById('rest-branch-name').value.trim();
    if (!branchName) {
      showBanner("‚ö†Ô∏è Please enter the Rest Branch Name before generating the file.");
      return;
    }
    if (restDayData.length === 0) {
      showBanner("‚ö†Ô∏è No Rest Day Schedule data found. Please paste it first.");
      return;
    }

    data = restDayData.map(item => ({
      'Employee No': item.empNo,
      'Rest Day Date': item.date
    }));

    const defaultFilename = 'REST_DAY_UPLOAD.xlsx';
    filename = branchName ? `${branchName}_${defaultFilename}` : defaultFilename;
  }

  else {
    showBanner("‚ö†Ô∏è Invalid generation type.");
    return;
  }

  // ‚úÖ Generate Excel file
  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'HRIS Upload');
  XLSX.writeFile(workbook, filename);

  // ‚úÖ Show success message
  showSuccessMessage();
}

// --- SUCCESS MESSAGE ---
function showSuccessMessage() {
  const msg = document.getElementById('success-message');
  msg.classList.remove('hidden', 'translate-x-full');
  msg.classList.add('translate-x-0');
  setTimeout(() => {
    msg.classList.remove('translate-x-0');
    msg.classList.add('translate-x-full');
    setTimeout(() => msg.classList.add('hidden'), 300);
  }, 3000);
}

// --- CLEAR ALL DATA ---
function clearAllData() {
  workScheduleData = [];
  restDayData = [];
  document.getElementById('work-schedule-paste').innerText = '';
  document.getElementById('rest-day-paste').innerText = '';
  document.getElementById('work-branch-name').value = '';
  document.getElementById('rest-branch-name').value = '';
  document.getElementById('summary').innerText = '';
  document.getElementById('summary').classList.remove('text-green-600');
  renderWorkTable();
  renderRestDayTable();
  updateButtonStates();

  // üßπ Optional: show confirmation banner
  const banner = document.getElementById('warning-banner');
  banner.textContent = "üßπ All data cleared successfully.";
  banner.classList.remove('hidden');
  banner.classList.add('opacity-100');
  setTimeout(() => {
    banner.classList.remove('opacity-100');
    setTimeout(() => banner.classList.add('hidden'), 500);
  }, 3000);
}

// --- TAB SWITCHING LOGIC ---

document.getElementById('tab-schedule').addEventListener('click', () => {
  document.getElementById('tab-schedule-content').classList.remove('hidden');
  document.getElementById('tab-monitoring-content').classList.add('hidden');
  document.getElementById('tab-schedule').classList.add('bg-indigo-600', 'text-white');
  document.getElementById('tab-monitoring').classList.remove('bg-indigo-600', 'text-white');
  document.getElementById('tab-monitoring').classList.add('bg-gray-200', 'text-gray-700');
});

document.getElementById('tab-monitoring').addEventListener('click', () => {
  document.getElementById('tab-monitoring-content').classList.remove('hidden');
  document.getElementById('tab-schedule-content').classList.add('hidden');
  document.getElementById('tab-monitoring').classList.add('bg-indigo-600', 'text-white');
  document.getElementById('tab-schedule').classList.remove('bg-indigo-600', 'text-white');
  document.getElementById('tab-schedule').classList.add('bg-gray-200', 'text-gray-700');
  loadMonitoringData();
});

// --- MONITORING DATA LOGIC ---
let monitoringData = [
  { name: 'AASP ABREEZA', checked: false, uploaded: false, uploadedBy: '', remarks: '' },
  { name: 'AASP NES - ATLAS', checked: false, uploaded: false, uploadedBy: '', remarks: '' },
  { name: 'AASP ANNEX', checked: false, uploaded: false, uploadedBy: '', remarks: '' },
  { name: 'AASP CDO', checked: false, uploaded: false, uploadedBy: '', remarks: '' },
  { name: 'AASP CEBU', checked: false, uploaded: false, uploadedBy: '', remarks: '' },
  { name: 'AASP CLARK', checked: false, uploaded: false, uploadedBy: '', remarks: '' },
  { name: 'AASP FESTIVAL', checked: false, uploaded: false, uploadedBy: '', remarks: '' },
  { name: 'GREE', checked: false, uploaded: false, uploadedBy: '', remarks: '' },
  { name: 'AASP GLORIETTA', checked: false, uploaded: false, uploadedBy: '', remarks: '' },
  { name: 'ASP ILOILO', checked: false, uploaded: false, uploadedBy: '', remarks: '' }
];

// ‚úÖ Initialize monitoring data only once
if (!localStorage.getItem('monitoringData')) {
  localStorage.setItem('monitoringData', JSON.stringify(monitoringData));
}
// ‚úÖ Remember selected month and year using localStorage
const monthSelect = document.getElementById('monthSelect');
const yearSelect = document.getElementById('yearSelect');

// üü¢ Load saved month/year on page load
const savedMonth = localStorage.getItem('selectedMonth');
const savedYear = localStorage.getItem('selectedYear');

if (savedMonth) monthSelect.value = savedMonth;
if (savedYear) yearSelect.value = savedYear;

// üü¢ Save month/year when changed
monthSelect.addEventListener('change', () => {
  localStorage.setItem('selectedMonth', monthSelect.value);
});

yearSelect.addEventListener('change', () => {
  localStorage.setItem('selectedYear', yearSelect.value);
});

// ‚úÖ Load monitoring data after all functions are ready
monitoringData = JSON.parse(localStorage.getItem('monitoringData'));
loadMonitoringData();

// ‚úÖ Save monitoring data to localStorage
function saveMonitoringData() {
  localStorage.setItem('monitoringData', JSON.stringify(monitoringData));
}



function loadMonitoringData() {
  const tbody = document.getElementById('monitoringBody');
  tbody.innerHTML = '';

  monitoringData.forEach((branch, index) => {
    tbody.innerHTML += `
      <tr>
        <td class="text-left">${branch.name}</td>
        <td><input type="checkbox" ${branch.checked ? 'checked' : ''} onchange="toggleCheck(${index})"></td>
        <td><input type="checkbox" ${branch.uploaded ? 'checked' : ''} onchange="toggleUpload(${index})"></td>
        <td><input type="text" value="${branch.uploadedBy || ''}" oninput="updateUploader(${index}, this.value)" class="border rounded px-2 py-1 w-full text-center"></td>
        <td><input type="text" value="${branch.remarks || ''}" oninput="updateRemarks(${index}, this.value)" class="border rounded px-2 py-1 w-full"></td>
        <td>${branch.uploaded ? '‚úÖ Done' : branch.checked ? '‚è≥ Checking' : '‚ùå Pending'}</td>
      </tr>
    `;
  });

  updateMonitoringProgress();
}

function updateMonitoringProgress() {
  const total = monitoringData.length;
  const checked = monitoringData.filter(b => b.checked).length;
  const uploaded = monitoringData.filter(b => b.uploaded).length;
  const percent = total ? Math.round((uploaded / total) * 100) : 0;

  document.getElementById('totalBranches').innerText = total;
  document.getElementById('checkedBranches').innerText = checked;
  document.getElementById('uploadedBranches').innerText = uploaded;
  document.getElementById('progressPercent').innerText = percent + '%';
  document.getElementById('progressBar').style.width = percent + '%';
}

function addBranch() {
  const name = document.getElementById('newBranchName').value.trim();
  if (!name) return alert('Please enter a branch name');
  monitoringData.push({ name, checked: false, uploaded: false, uploadedBy: '', remarks: '' });
  saveMonitoringData();
  loadMonitoringData();
  document.getElementById('newBranchName').value = '';
}

function toggleCheck(index) {
  monitoringData[index].checked = !monitoringData[index].checked;
  saveMonitoringData();
  loadMonitoringData();
}

function toggleUpload(index) {
  monitoringData[index].uploaded = !monitoringData[index].uploaded;
  monitoringData[index].uploadedBy = monitoringData[index].uploaded ? 'HR Staff' : '';
  saveMonitoringData();
  loadMonitoringData();
}
function updateUploader(index, value) {
  monitoringData[index].uploadedBy = value;
  saveMonitoringData();
}

function updateRemarks(index, value) {
  monitoringData[index].remarks = value;
  saveMonitoringData();
}

document.getElementById('addBranchBtn').addEventListener('click', addBranch);

document.getElementById('clearMonitoringBtn').addEventListener('click', () => {
  if (confirm('Are you sure you want to clear all monitoring data?')) {
    monitoringData = [];
    saveMonitoringData();
    loadMonitoringData();
  }
});

document.getElementById('exportMonitoringBtn').addEventListener('click', () => {
  if (monitoringData.length === 0) return alert('No data to export');

  // ‚úÖ Get selected month and year text
  const monthSelect = document.getElementById('monthSelect');
  const yearSelect = document.getElementById('yearSelect');
  const monthName = monthSelect.options[monthSelect.selectedIndex].text;
  const yearValue = yearSelect.value;

  // ‚úÖ Create a header row
  const header = [`üìä WS and RD Monitoring for the Month of ${monthName} ${yearValue}`];

  // ‚úÖ Convert data to sheet
  const ws = XLSX.utils.json_to_sheet(monitoringData);

  // ‚úÖ Insert header row above the data
  XLSX.utils.sheet_add_aoa(ws, [header], { origin: 'A1' });

  // ‚úÖ Adjust columns (shift data down)
  XLSX.utils.sheet_add_json(ws, monitoringData, { origin: 'A3', skipHeader: false });

  // ‚úÖ Create workbook and save file
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Monitoring');
  XLSX.writeFile(wb, `Branch_Monitoring_${monthName}_${yearValue}.xlsx`);
});
// üßπ Clear buttons
document.getElementById('clearWorkData').addEventListener('click', () => {
  document.getElementById('workScheduleInput').value = '';
  document.getElementById('workBranchName').value = '';
  document.getElementById('workTableBody').innerHTML = '';
});

document.getElementById('clearRestData').addEventListener('click', () => {
  document.getElementById('restScheduleInput').value = '';
  document.getElementById('restBranchName').value = '';
  document.getElementById('restTableBody').innerHTML = '';
});

document.getElementById('clearAllBtn').addEventListener('click', () => {
  document.getElementById('workScheduleInput').value = '';
  document.getElementById('restScheduleInput').value = '';
  document.getElementById('workBranchName').value = '';
  document.getElementById('restBranchName').value = '';
  document.getElementById('workTableBody').innerHTML = '';
  document.getElementById('restTableBody').innerHTML = '';
});


</script>
</body>
</html>